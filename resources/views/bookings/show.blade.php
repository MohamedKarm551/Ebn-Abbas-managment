@extends('layouts.app')
{{-- *** ุจุฏุงูุฉ ุงูููุฏ ุงูุฌุฏูุฏ: ุชุญุฏูุฏ ุนููุงู ุงูุตูุญุฉ *** --}}
@section('title', 'ุชูุงุตูู ุญุฌุฒ : ' . $booking->client_name)
{{-- *** ููุงูุฉ ุงูููุฏ ุงูุฌุฏูุฏ *** --}}

<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="{{ asset('icons/booking-details.svg') }}">
</head>

@section('content')
    @php
        $total_nights = \Carbon\Carbon::parse($booking->check_in)->diffInDays(
            \Carbon\Carbon::parse($booking->check_out),
        );
        $editLogs = \App\Models\EditLog::where('booking_id', $id)->orderBy('created_at', 'desc')->get();
    @endphp
    <div class="container">
        <div class="row align-items-center mb-3">
            <div class="col-12 col-lg-7 mb-2 mb-lg-0">
                <h1 class="h4 mb-0 text-center text-lg-start">ุชูุงุตูู ุงูุญุฌุฒ ููุนููู: {{ $booking->client_name }}
                    <br> <br>
                    <a href="{{ route('bookings.voucher', $booking->id) }}" class="btn btn-warning btn-sm" target="_blank">
                        ุนุฑุถ ุงููุงูุชุดุฑ
                    </a>
                    @if (Auth::user()->role === 'Admin')
                        <button type="button" class="btn btn-success" data-bs-toggle="modal"
                            data-bs-target="#registerPaymentModal">
                            ๐ธ ุชุณุฌูู ุฏูุนุฉ
                        </button>
                    @endif
                    <button type="button" class="btn btn-info ms-2" data-bs-toggle="modal"
                        data-bs-target="#financialTrackingModal" onclick="loadFinancialTracking({{ $booking->id }})"
                        title="ุฅุฏุงุฑุฉ ุงููุชุงุจุนุฉ ุงููุงููุฉ ููุญุฌุฒ">
                        <i class="fas fa-chart-line me-1"></i>
                        ุญุงูุฉ ุงูุชุญุตูู ูุงูุณุฏุงุฏ
                    </button>
                </h1>
            </div>
            <div class="col-12 col-lg-5 d-flex justify-content-center justify-content-lg-end gap-2">
                <a href="{{ route('bookings.index') }}" class="btn btn-secondary">ุฑุฌูุน โก</a>
                <button id="copyBookingDetails" class="btn btn-primary">๐ ูุณุฎ ุจูุงูุงุช ุงูุญุฌุฒ ๐</button>
                <button id="calculate-total" class="btn btn-info">๐ ุงูุงุฌูุงูู ๐</button>
            </div>

        </div>
        <table class="table  table-hover table-bordered text-center">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ุงูุนููุงู</th>
                    <th>ุงููููุฉ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td>ุงุณู ุงูุดุฑูุฉ <i class="fas fa-building text-primary"></i></td>
                    <td>{{ $booking->company->name ?? 'ุบูุฑ ูุญุฏุฏ' }}</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>ุฌูุฉ ุงูุญุฌุฒ <i class="fas fa-user-tie text-success"></i></td>
                    <td>{{ $booking->agent->name ?? 'ุบูุฑ ูุญุฏุฏ' }}</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>ุงุณู ุงูููุฏู <i class="fas fa-hotel text-info"></i></td>
                    <td>{{ $booking->hotel->name ?? 'ุบูุฑ ูุญุฏุฏ' }}</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>ููุน ุงูุบุฑูุฉ <i class="fas fa-bed text-warning"></i></td>
                    <td>{{ $booking->room_type }}</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>ุนุฏุฏ ุงูุบุฑู <i class="fas fa-door-open text-danger"></i></td>
                    <td>{{ $booking->rooms }}</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>ุชุงุฑูุฎ ุงูุฏุฎูู <i class="fas fa-calendar-check text-primary"></i></td>
                    <td>{{ $booking->check_in->format('d/m/Y') }} <small class="d-block text-muted hijri-date"
                            data-date="{{ $booking->check_in->format('Y-m-d') }}"></small>
                    </td>
                </tr>
                <tr>
                    <td>7</td>
                    <td>ุชุงุฑูุฎ ุงูุฎุฑูุฌ <i class="fas fa-calendar-times text-danger"></i></td>
                    <td>{{ $booking->check_out->format('d/m/Y') }} <small class="d-block text-muted hijri-date"
                            data-date="{{ $booking->check_out->format('Y-m-d') }}"></small>
                    </td>
                </tr>
                <tr>
                    <td>8</td>
                    <td>ุนุฏุฏ ุงูููุงูู <i class="fas fa-moon text-warning"></i></td>
                    <td>{{ $total_nights }} ูููุฉ</td>
                </tr>
                <tr>
                    <td>9</td>
                    <td>ุงูุฃูุงู ุงููุชุจููุฉ ุญุชู ุงูุฎุฑูุฌ <i class="fas fa-clock text-info"></i></td>
                    <td>
                        @php
                            // ูุถุจุท ููุช ููุง ุงูุชุงุฑูุฎูู ูุจุฏุงูุฉ ุงูููู (00:00:00)
                            $today = \Carbon\Carbon::now()->startOfDay();
                            $checkoutDate = \Carbon\Carbon::parse($booking->check_out)->startOfDay();
                            // ูุญุณุจ ุงููุฑู ุจุงูุฃูุงู ุงูุตุญูุญุฉ (ูุน ุชุฌุงูู ุงูุฅุดุงุฑุฉ ุงูุณุงูุจุฉ ูู ุงูุชุงุฑูุฎ ูุงุช)
                        $remaining_days = $today->diffInDays($checkoutDate, false); @endphp
                        {{ $remaining_days > 0 ? intval($remaining_days) . ' ููู' : 'ุงูุชูู ุงูุญุฌุฒ' }}
                    </td>

                </tr>
                <tr>
                    <td>10</td>
                    <td> ุงูุณุนุฑ ูู ุงูููุฏู <i class="fas fa-money-bill-wave text-success"></i></td>
                    <td>{{ $booking->cost_price }} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}</td>
                </tr>
                <!-- ุตู ุงููุณุชุญู ููููุฏู ุงููุญุณูุจ ุฏููุงููููุงู -->
                <tr id="hotel-due-row">
                    <td>11</td>
                    <td>ุงููุณุชุญู ููููุฏู <i class="fas fa-hand-holding-usd text-info"></i></td>
                    <td id="hotel-due-value">{{ $total_nights * $booking->rooms * $booking->cost_price }}
                        {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}</td>
                </tr>
                <tr>
                    <td>12</td>
                    <td> ุงููุจูุบ ุงููุฏููุน ููููุฏู <i class="fas fa-money-check-alt text-primary"></i></td>
                    <td>{{ $booking->amount_paid_to_hotel }}
                        {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}</td>
                </tr>
                <tr>
                    <td>13</td>
                    <td> ุงูุจุงูู ููููุฏู <i class="fas fa-money-check text-danger"></i></td>
                    <td>{{ $booking->amount_due_to_hotel - $booking->amount_paid_to_hotel }}
                        {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}</td>
                </tr>
                <tr>
                    <td>14</td>
                    <td> ุณุนุฑ ุงูุจูุน ููุดุฑูุฉ <i class="fas fa-tag text-warning"></i> </td>
                    <td>{{ $booking->sale_price }} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}</td>
                </tr>
                <tr>
                    <td>15</td>
                    <td>ุงููุจูุบ ุงูููู ุงููุณุชุญู ูู ุงูุดุฑูุฉ <i class="fas fa-hand-holding-usd text-success"></i> </td>
                    <td>{{ number_format($booking->amount_due_from_company, 2) }}
                        {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}
                    </td>
                </tr>
                <tr>
                    <td>16</td>
                    <td> ุงููุจูุบ ุงููุฏููุน ูู ุงูุดุฑูุฉ<i class="fas fa-wallet text-info"></i> </td>
                    <td>{{ number_format($booking->amount_paid_by_company, 2) }}
                        {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }} </td>
                </tr>
                <tr>
                    <td>17</td>
                    <td>ุงูุจุงูู ุนูู ุงูุดุฑูุฉ <i class="fas fa-balance-scale text-danger"></i> </td>
                    <td>{{ number_format($booking->amount_due_from_company - $booking->amount_paid_by_company, 2) }}
                        {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }} </td>
                </tr>
                <tr>
                    <td>18</td>
                    <td> ุงูููุธู ุงููุณุคูู <i class="fas fa-user text-primary"></i> </td>
                    <td>{{ $booking->employee->name ?? 'ุบูุฑ ูุญุฏุฏ' }}</td>
                </tr>
                <tr>
                    <td>19</td>
                    <td>ุงูููุงุญุธุงุช <i class="fas fa-sticky-note text-warning"></i></td>
                    <td class="notes-cell">
                        @php
                            $notes = $booking->notes ?? '';

                            if (!empty($notes)) {
                                // ููุท ููุชุนุฑู ุนูู ุงูุฑูุงุจุท
                                $pattern =
                                    '/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/i';

                                // ุชูุณูู ุงููุต ุนูุฏ ุงูุฑูุงุจุท ููุชุนุงูู ูุนูุง ุจุดูู ูููุตู
                                $parts = preg_split($pattern, $notes, -1, PREG_SPLIT_DELIM_CAPTURE);

                                $formatted = '';
                                $wordCount = 0;

                                foreach ($parts as $index => $part) {
                                    // ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฐุง ุงูุฌุฒุก ุฑุงุจุทุงู
                                    if ($index % 2 === 1 || preg_match($pattern, $part)) {
                                        // ูุฐุง ุฑุงุจุท - ูุญููู ุฅูู ุฒุฑ
                                        $url = $part;
                                        if (!str_starts_with($url, 'http')) {
                                            $url = 'https://' . $url;
                                        }

                                        // ุชุญุฏูุฏ ููุน ุงูุฒุฑ ุจูุงุก ุนูู ุงูุฑุงุจุท
                                        $btnClass = 'btn-primary';
                                        $btnText = 'ูุชุญ ุงูุฑุงุจุท';
                                        $btnIcon = 'link';

                                        if (strpos($url, 'drive.google.com') !== false) {
                                            $btnClass = 'btn-success';
                                            $btnText = 'ูุชุญ ุงูููู';
                                            $btnIcon = 'file';
                                        }

                                        // ุฅุถุงูุฉ ุงูุฒุฑ ุจุชูุณูู Bootstrap
                                        $formatted .=
                                            ' <a href="' .
                                            e($url) .
                                            '" target="_blank" class="btn btn-sm ' .
                                            $btnClass .
                                            '" style="white-space: nowrap; margin: 2px;"><i class="fas fa-' .
                                            $btnIcon .
                                            '"></i> ' .
                                            $btnText .
                                            '</a> ';

                                        // ุฅุถุงูุฉ ุณุทุฑ ุฌุฏูุฏ ุจุนุฏ ุงูุฒุฑ
                                        $formatted .= '<br>';
                                        $wordCount = 0;
                                    } else {
                                        // ูุฐุง ูุต ุนุงุฏู - ููุณูู ุฅูู ูููุงุช
                                        $words = preg_split('/\s+/', $part);
                                        foreach ($words as $word) {
                                            if (!empty($word)) {
                                                $formatted .= $word . ' ';
                                                $wordCount++;

                                                // ุฅุถุงูุฉ ุณุทุฑ ุฌุฏูุฏ ุจุนุฏ ูู 7 ูููุงุช
                                                if ($wordCount >= 7) {
                                                    $formatted .= '<br>';
                                                    $wordCount = 0;
                                                }
                                            }
                                        }
                                    }
                                }

                                // ุฅุฒุงูุฉ ุฃู <br> ุฒุงุฆุฏ ูู ุงูููุงูุฉ
                                $formatted = rtrim($formatted, '<br>');
                                $notes = $formatted;
                            }
                        @endphp
                        {!! $notes !!}
                    </td>
                </tr>
            </tbody>
        </table>

        <h3>ุณุฌู ุงูุชุนุฏููุงุช</h3>
        @if ($editLogs->isEmpty())
            <p>ูุง ุชูุฌุฏ ุชุนุฏููุงุช ูุณุฌูุฉ ููุฐุง ุงูุญุฌุฒ.</p>
        @else
            @php
                $fieldNames = [
                    'id' => '#',
                    'client_name' => 'ุงุณู ุงูุนููู',
                    'company_id' => 'ุงูุดุฑูุฉ',
                    'agent_id' => 'ุฌูุฉ ุงูุญุฌุฒ',
                    'hotel_id' => 'ุงูููุฏู',
                    'room_type' => 'ููุน ุงูุบุฑูุฉ',
                    'check_in' => 'ุชุงุฑูุฎ ุงูุฏุฎูู',
                    'check_out' => 'ุชุงุฑูุฎ ุงูุฎุฑูุฌ',
                    'days' => 'ุนุฏุฏ ุงูุฃูุงู',
                    'rooms' => 'ุนุฏุฏ ุงูุบุฑู',
                    'cost_price' => 'ุณุนุฑ ุงูููุฏู',
                    'amount_due_to_hotel' => 'ุงููุจูุบ ุงููุณุชุญู ููููุฏู',
                    'amount_paid_to_hotel' => 'ุงููุฏููุน ููููุฏู',
                    'sale_price' => 'ุณุนุฑ ุงูุจูุน',
                    'employee_id' => 'ุงูููุธู ุงููุณุคูู',
                    'amount_due_from_company' => 'ุงููุจูุบ ุงููุณุชุญู ูู ุงูุดุฑูุฉ',
                    'amount_paid_by_company' => 'ุงููุฏููุน ูู ุงูุดุฑูุฉ',
                    'payment_status' => 'ุญุงูุฉ ุงูุณุฏุงุฏ',
                    'notes' => 'ุงูููุงุญุธุงุช',
                    'created_at' => 'ุชุงุฑูุฎ ุงูุฅูุดุงุก',
                    'updated_at' => 'ุขุฎุฑ ุชุนุฏูู',
                ];
            @endphp
            <table class="table  table-hover table-bordered text-center ">
                <thead>
                    <tr>
                        <th>ุงูุญูู ุงููุนุฏู</th>
                        <th>ุงููููุฉ ุงููุฏููุฉ</th>
                        <th>ุงููููุฉ ุงูุฌุฏูุฏุฉ</th>
                        <th>ุชุงุฑูุฎ ุงูุชุนุฏูู</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach ($editLogs as $log)
                        @if (trim($log->old_value) !== trim($log->new_value))
                            <!-- ุชุฌุงูู ุงูุญููู ุบูุฑ ุงููุนุฏูุฉ -->
                            <tr>
                                <!-- ุนุฑุถ ุงุณู ุงูุญูู ุงููุนุฏู -->
                                <td>{{ $fieldNames[$log->field] ?? $log->field }}</td>

                                <!-- ุนุฑุถ ุงููููุฉ ุงููุฏููุฉ -->
                                <td>
                                    @if ($log->field === 'employee_id')
                                        <!-- ุฅุฐุง ูุงู ุงูุญูู ูู ุงูููุธู ุงููุณุคููุ ุฌูุจ ุงุณู ุงูููุธู ุจุฏูุงู ูู ุงูู ID -->
                                        {{ \App\Models\Employee::find($log->old_value)?->name ?? $log->old_value }}
                                    @elseif ($log->field === 'company_id')
                                        <!-- ุฅุฐุง ูุงู ุงูุญูู ูู ุงูุดุฑูุฉุ ุฌูุจ ุงุณู ุงูุดุฑูุฉ ุจุฏูุงู ูู ุงูู ID -->
                                        {{ \App\Models\Company::find($log->old_value)?->name ?? $log->old_value }}
                                    @elseif ($log->field === 'hotel_id')
                                        <!-- ุฅุฐุง ูุงู ุงูุญูู ูู ุงูููุฏูุ ุฌูุจ ุงุณู ุงูููุฏู ุจุฏูุงู ูู ุงูู ID -->
                                        {{ \App\Models\Hotel::find($log->old_value)?->name ?? $log->old_value }}
                                    @elseif ($log->field === 'agent_id')
                                        <!-- ุฅุฐุง ูุงู ุงูุญูู ูู ุฌูุฉ ุงูุญุฌุฒุ ุฌูุจ ุงุณู ุฌูุฉ ุงูุญุฌุฒ ุจุฏูุงู ูู ุงูู ID -->
                                        {{ \App\Models\Agent::find($log->old_value)?->name ?? $log->old_value }}
                                    @elseif (in_array($log->field, ['check_in', 'check_out']))
                                        <!-- ุฅุฐุง ูุงู ุงูุญูู ูู ุชุงุฑูุฎุ ุชูุณูู ุงูุชุงุฑูุฎ ูุนุฑุถู ุจุดูู ููุงุณุจ -->
                                        {{ $log->old_value ? \Carbon\Carbon::parse($log->old_value)->format('d/m/Y') : 'ุบูุฑ ูุญุฏุฏ' }}
                                    @else
                                        <!-- ุนุฑุถ ุงููููุฉ ุงููุฏููุฉ ููุง ูู ุฅุฐุง ูู ุชูู ูู ุงูุญููู ุงูุฎุงุตุฉ -->
                                        {{ $log->old_value ?: 'ุบูุฑ ูุญุฏุฏ' }}
                                    @endif
                                </td>

                                <!-- ุนุฑุถ ุงููููุฉ ุงูุฌุฏูุฏุฉ -->
                                <td>
                                    @if ($log->field === 'employee_id')
                                        <!-- ุฅุฐุง ูุงู ุงูุญูู ูู ุงูููุธู ุงููุณุคููุ ุฌูุจ ุงุณู ุงูููุธู ุงูุฌุฏูุฏ ุจุฏูุงู ูู ุงูู ID -->
                                        {{ \App\Models\Employee::find($log->new_value)?->name ?? $log->new_value }}
                                    @elseif ($log->field === 'company_id')
                                        <!-- ุฅุฐุง ูุงู ุงูุญูู ูู ุงูุดุฑูุฉุ ุฌูุจ ุงุณู ุงูุดุฑูุฉ ุงูุฌุฏูุฏ ุจุฏูุงู ูู ุงูู ID -->
                                        {{ \App\Models\Company::find($log->new_value)?->name ?? $log->new_value }}
                                    @elseif ($log->field === 'hotel_id')
                                        <!-- ุฅุฐุง ูุงู ุงูุญูู ูู ุงูููุฏูุ ุฌูุจ ุงุณู ุงูููุฏู ุงูุฌุฏูุฏ ุจุฏูุงู ูู ุงูู ID -->
                                        {{ \App\Models\Hotel::find($log->new_value)?->name ?? $log->new_value }}
                                    @elseif ($log->field === 'agent_id')
                                        <!-- ุฅุฐุง ูุงู ุงูุญูู ูู ุฌูุฉ ุงูุญุฌุฒุ ุฌูุจ ุงุณู ุฌูุฉ ุงูุญุฌุฒ ุงูุฌุฏูุฏ ุจุฏูุงู ูู ุงูู ID -->
                                        {{ \App\Models\Agent::find($log->new_value)?->name ?? $log->new_value }}
                                    @elseif (in_array($log->field, ['check_in', 'check_out']))
                                        <!-- ุฅุฐุง ูุงู ุงูุญูู ูู ุชุงุฑูุฎุ ุชูุณูู ุงูุชุงุฑูุฎ ุงูุฌุฏูุฏ ูุนุฑุถู ุจุดูู ููุงุณุจ -->
                                        {{ $log->new_value ? \Carbon\Carbon::parse($log->new_value)->format('d/m/Y') : 'ุบูุฑ ูุญุฏุฏ' }}
                                    @else
                                        <!-- ุนุฑุถ ุงููููุฉ ุงูุฌุฏูุฏุฉ ููุง ูู ุฅุฐุง ูู ุชูู ูู ุงูุญููู ุงูุฎุงุตุฉ -->
                                        {{ $log->new_value !== null && $log->new_value !== '' ? $log->new_value : 'ุบูุฑ ูุญุฏุฏ' }}
                                    @endif
                                </td>

                                <!-- ุนุฑุถ ุชุงุฑูุฎ ุงูุชุนุฏูู -->
                                <td>{{ \Carbon\Carbon::parse($log->created_at)->format('d/m/Y H:i') }}</td>
                            </tr>
                        @endif
                    @endforeach
                </tbody>
            </table>
        @endif
        {{-- <ul id="editLog"></ul>
    <pre>{{ print_r($editLogs->toArray()) }}</pre> --}}
    </div>



    <style>
        body {
            background-color: #121212;
            color: #ffffff;
        }

        .table {
            border-color: #444;
        }

        .table th,
        .table td {
            vertical-align: middle;
        }

        .table-hover tbody tr:hover {
            background-color: #333;
        }

        .copyable {
            cursor: pointer;
            color: #00bcd4;
        }

        .copyable:hover {
            text-decoration: underline;
        }

        .alert {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            /* ูุถูุงู ุธููุฑู ููู ุฌููุน ุงูุนูุงุตุฑ */
            padding: 15px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            width: 90%;
            /* ุนุฑุถ ุงูุชูุจูู */
            max-width: 500px;
            /* ุงูุญุฏ ุงูุฃูุตู ููุนุฑุถ */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        .d-flex {
            display: flex;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .align-items-center {
            align-items: center;
        }

        .mb-3 {
            margin-bottom: 1rem;
        }

        .btn {
            margin-left: 5px;
        }
    </style>



    <script src="{{ asset('js/preventClick.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const copyButton = document.getElementById('copyBookingDetails');
            if (copyButton) {
                copyButton.addEventListener('click', function() {
                    try {
                        const bookingDetails =
                            `๐ *ุชูุงุตูู ุงูุญุฌุฒ ููุนููู:* {{ $booking->client_name }}\n\n` +
                            Array.from(document.querySelectorAll('.table tbody tr'))
                            .map(row => {
                                const cells = row.querySelectorAll('td'); // ุงุณุชุฎุฑุงุฌ ุงูุฃุนูุฏุฉ
                                const number = cells[0]?.innerText.trim(); // ุงูุฑูู
                                const title = cells[1]?.innerText.trim(); // ุงูุนููุงู
                                const value = cells[2]?.innerText.trim(); // ุงููููุฉ

                                // ุฅุถุงูุฉ ุงูุฅูููุฌู ุงูููุงุณุจุฉ ุจูุงุกู ุนูู ุงูุนููุงู
                                let emoji = '';
                                if (title.includes('ุงุณู ุงูุดุฑูุฉ')) emoji = '๐ข';
                                else if (title.includes('ุฌูุฉ ุงูุญุฌุฒ')) emoji = '๐';
                                else if (title.includes('ุงุณู ุงูููุฏู')) emoji = '๐จ';
                                else if (title.includes('ููุน ุงูุบุฑูุฉ')) emoji = '๐๏ธ';
                                else if (title.includes('ุนุฏุฏ ุงูุบุฑู')) emoji = '๐ช';
                                else if (title.includes('ุชุงุฑูุฎ ุงูุฏุฎูู') || title.includes(
                                        'ุชุงุฑูุฎ ุงูุฎุฑูุฌ')) emoji = '๐';
                                else if (title.includes('ุนุฏุฏ ุงูููุงูู')) emoji = '๐';
                                else if (title.includes('ุงูุฃูุงู ุงููุชุจููุฉ ุญุชู ุงูุฎุฑูุฌ')) emoji = 'โณ';
                                else if (title.includes('ุงูุณุนุฑ ูู ุงูููุฏู')) emoji = '๐ต';
                                else if (title.includes('ุงููุณุชุญู ููููุฏู')) emoji =
                                    '๐ถ'; // ุฅุถุงูุฉ ุฅูููุฌู ูููุณุชุญู ููููุฏู
                                else if (title.includes('ุงููุจูุบ ุงููุฏููุน ููููุฏู')) emoji = '๐ณ';
                                else if (title.includes('ุงูุจุงูู ููููุฏู')) emoji = '๐ธ';
                                else if (title.includes('ุณุนุฑ ุงูุจูุน ููุดุฑูุฉ')) emoji = '๐ต';
                                else if (title.includes('ุงููุจูุบ ุงููุณุชุญู ูู ุงูุดุฑูุฉ')) emoji = '๐ฐ';
                                else if (title.includes('ุงููุจูุบ ุงููุฏููุน ูู ุงูุดุฑูุฉ')) emoji = '๐ผ';
                                else if (title.includes('ุงูุจุงูู ูู ุงูุดุฑูุฉ')) emoji = 'โ๏ธ';
                                else if (title.includes('ุงูููุธู ุงููุณุคูู')) emoji = '๐ค';
                                else if (title.includes('ุงูููุงุญุธุงุช')) emoji = '๐';

                                return `${emoji} ${number}. ${title}: ${value}`; // ุฏูุฌ ุงููุตูุต ูุน ุงูุฅูููุฌู
                            })
                            .join('\n'); // ูุตู ุงููุตูุต ุจุฎุท ุฌุฏูุฏ

                        navigator.clipboard.writeText(bookingDetails).then(() => {
                            showAlert('ุชู ูุณุฎ ุจูุงูุงุช ุงูุญุฌุฒ ุจูุฌุงุญ!', 'success');
                        }).catch(err => {
                            console.error('ุฎุทุฃ ุฃุซูุงุก ูุณุฎ ุงูุจูุงูุงุช:', err);
                            showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุณุฎ ุงูุจูุงูุงุช.', 'danger');
                        });
                    } catch (error) {
                        console.error('ุฎุทุฃ ุบูุฑ ูุชููุน:', error);
                        showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุณุฎ ุงูุจูุงูุงุช.', 'danger');
                    }
                });
            }

            // ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "calculate-total"
            document.getElementById('calculate-total').addEventListener('click', function() {
                let totalDueFromCompany = 0;
                let totalDueToHotel = 0;
                let profitPerNight = 0;
                let profitSoFar = 0;
                let totalProfit = 0;

                // ุญุณุงุจ ุนุฏุฏ ุงูููุงูู ุงูุชู ูุถุงูุง ุงูุนููู ุญุชู ุงูุขู
                let checkInDate = new Date("{{ $booking->check_in }}");
                let checkOutDate = new Date("{{ $booking->check_out }}");
                let today = new Date();

                let nightsStayed = Math.min(
                    Math.max(0, Math.ceil((today - checkInDate) / (1000 * 60 * 60 * 24))),
                    {{ $booking->days }}
                );

                // ุญุณุงุจ ุนุฏุฏ ุงูููุงูู ุงูุฅุฌูุงููุฉ
                let totalNights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));

                // ุญุณุงุจ ุงูุฅุฌูุงูู ูู ุงูุดุฑูุฉ ูุงูููุฏู
                totalDueFromCompany = nightsStayed * {{ $booking->rooms }} * {{ $booking->sale_price }};
                totalDueToHotel = nightsStayed * {{ $booking->rooms }} * {{ $booking->cost_price }};

                // ุชุญุฏูุซ ุตู "ุงููุณุชุญู ููููุฏู" ุจุงููููุฉ ุงููุญุณูุจุฉ
                document.getElementById('hotel-due-value').innerText = totalDueToHotel +
                    ' {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}';

                // ุญุณุงุจ ุงูููุณุจ
                profitPerNight = ({{ $booking->sale_price }} - {{ $booking->cost_price }}) *
                    {{ $booking->rooms }};
                profitSoFar = profitPerNight * nightsStayed;
                totalProfit = profitPerNight * totalNights;

                // ุงููุจุงูุบ ุงููุฏููุนุฉ
                let amountPaidByCompany = {{ $booking->amount_paid_by_company }};
                let amountPaidToHotel = {{ $booking->amount_paid_to_hotel }};

                // ุญุณุงุจ ุงููุจุงูุบ ุงููุชุจููุฉ
                let remainingFromCompany = totalDueFromCompany - amountPaidByCompany;
                let remainingToHotel = totalDueToHotel - amountPaidToHotel;

                // ุจูุงุก ุฑุณุงูุฉ ุงูุชูุจูู ุจุงูุชูุงุตูู ุจูุง ูู ุฐูู ุงููุณุชุญู ููููุฏู
                let alertMessage = `๐ฒ ุงูุฅุฌูุงูู ุญุชู ุงูุขู: ๐ฒ

ูุง ูู ูู ุงูุดุฑูุฉ: ${nightsStayed} ูููุฉ * {{ $booking->rooms }} ุบุฑูุฉ * {{ $booking->sale_price }} ุณุนุฑ ุงููููุฉ = ${totalDueFromCompany} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}  
ูุง ุนููู ููููุฏู: ${nightsStayed} ูููุฉ * {{ $booking->rooms }} ุบุฑูุฉ * {{ $booking->cost_price }} ุณุนุฑ ุงูููุฏู = ${totalDueToHotel} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}  

๐ฐ ุงูููุณุจ:
- ุงูููุณุจ ููู ูููุฉ: ${profitPerNight} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}
- ุงูููุณุจ ุญุชู ุงูุขู: ${profitSoFar} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}
- ุงูููุณุจ ุงูุฅุฌูุงูู: ${totalProfit} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}

๐ณ ุงููุจุงูุบ ุงููุฏููุนุฉ:
- ุงููุฏููุน ูู ุงูุดุฑูุฉ: ${amountPaidByCompany} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}
- ุงููุฏููุน ููููุฏู: ${amountPaidToHotel} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}

โ๏ธ ุงููุจุงูุบ ุงููุชุจููุฉ:
- ุงููุชุจูู ูู ุงูุดุฑูุฉ: ${remainingFromCompany} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}
- ุงููุชุจูู ููููุฏู: ${remainingToHotel} {{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}`;

                showAlert(alertMessage, 'info');
            });

            function showAlert(message, type) {
                const alertBox = document.createElement('div');
                alertBox.className = `alert alert-${type}`;
                alertBox.innerText = message;

                // ุฅุถุงูุฉ ุงูุชูุจูู ุฅูู ุฃุนูู ุงูุตูุญุฉ
                document.body.appendChild(alertBox);

                // ุฅุฒุงูุฉ ุงูุชูุจูู ุจุนุฏ 5 ุซูุงูู
                setTimeout(() => {
                    alertBox.remove();
                }, 5000);
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ุงููุชุบูุฑุงุช ุงูุซุงุจุชุฉ
            let originalAmountDue = {{ $booking->amount_due_from_company }};
            let originalAmountPaid = {{ $booking->amount_paid_by_company }};
            let originalRemaining = originalAmountDue - originalAmountPaid;
            const currency = "{{ $booking->currency === 'SAR' ? 'ุฑูุงู ุณุนูุฏู' : 'ุฏููุงุฑ ูููุชู' }}";

            // ูููุฐุฌ ุงูุฏูุนุฉ
            const paymentForm = document.getElementById('paymentForm');
            if (paymentForm) {
                paymentForm.addEventListener('submit', function(e) {
                    // ูุฑุงุกุฉ ุงููุจูุบ ุงููุฏุฎู
                    const paymentAmount = parseFloat(document.getElementById('payment-amount').value);
                    if (isNaN(paymentAmount) || paymentAmount <= 0) {
                        showAlert('ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ', 'danger');
                        e.preventDefault();
                        return;
                    }

                    // ุงูุชุฃูุฏ ูู ุฃู ุงูุนููุฉ ูุชุทุงุจูุฉ
                    const paymentCurrency = document.getElementById('payment-currency').value;
                    if (paymentCurrency !== "{{ $booking->currency }}") {
                        showAlert('ูุฌุจ ุฃู ุชููู ุนููุฉ ุงูุฏูุน ูุชุทุงุจูุฉ ูุน ุนููุฉ ุงูุญุฌุฒ: {{ $booking->currency }}',
                            'warning');
                        e.preventDefault();
                        return;
                    }

                    // ุญุณุงุจ ุงูููู ุงูุฌุฏูุฏุฉ (ููุนุฑุถ ููุท - ุงูุจูุงูุงุช ุงููุนููุฉ ุณุชุฃุชู ูู ุงูุณูุฑูุฑ)
                    const newAmountPaid = originalAmountPaid + paymentAmount;
                    const newRemaining = originalAmountDue - newAmountPaid;

                    // ุชุญุฏูุซ ุงููุนูููุงุช ุงููุนุฑูุถุฉ ูุณุจูุงู (ูุจู ุงูุงุณุชุฌุงุจุฉ ูู ุงูุณูุฑูุฑ)
                    updateDisplayedValues(newAmountPaid, newRemaining);

                    // ุฅุฎูุงุก ุงูููุฏุงู
                    const modal = bootstrap.Modal.getInstance(document.getElementById(
                        'registerPaymentModal'));
                    if (modal) {
                        modal.hide();
                    }

                    // ุนุฑุถ ุฑุณุงูุฉ ูููุณุชุฎุฏู ุฃููุง ูุนุงูุฌ ุงูุทูุจ
                    showAlert('ุฌุงุฑู ูุนุงูุฌุฉ ุงูุฏูุนุฉ...', 'info');

                    // ุชุญุฏูุซ ุงููุชุบูุฑุงุช ุงููุญููุฉ ููุงุณุชุฎุฏุงู ูู ุงูุนูููุงุช ุงูุชุงููุฉ
                    originalAmountPaid = newAmountPaid;
                    originalRemaining = newRemaining;
                });
            }

            // ุฏุงูุฉ ุชุญุฏูุซ ุงูููู ุงููุนุฑูุถุฉ
            function updateDisplayedValues(newPaid, newRemaining) {
                // ุชุญุฏูุซ ุงููุจูุบ ุงููุฏููุน ูู ุงูุดุฑูุฉ (ุงูุตู 16)
                const paidCell = document.querySelector('tr:nth-child(16) td:last-child');
                if (paidCell) {
                    paidCell.innerHTML = `
                    <span class="new-value">${number_format(newPaid, 2)} ${currency}</span>
                    <span class="original-value">(${number_format(originalAmountPaid, 2)})</span>
                `;
                }

                // ุชุญุฏูุซ ุงููุจูุบ ุงููุชุจูู ูู ุงูุดุฑูุฉ (ุงูุตู 17)
                const remainingCell = document.querySelector('tr:nth-child(17) td:last-child');
                if (remainingCell) {
                    const remainingClass = newRemaining <= 0 ? 'text-success fw-bold' : 'text-warning';
                    remainingCell.innerHTML = `
                    <span class="new-value ${remainingClass}">${number_format(newRemaining, 2)} ${currency}</span>
                    <span class="original-value">(${number_format(originalRemaining, 2)})</span>
                `;
                }

                // ุชุญุฏูุซ ุงููุจูุบ ุงููุณุชุญู ูู ุงูุดุฑูุฉ (ุงูุตู 15) - ุฅุธูุงุฑ ุงููููุฉ ุงูุฃุตููุฉ ูุดุทูุจุฉ ูุน ุงูุฌุฏูุฏุฉ
                const dueCell = document.querySelector('tr:nth-child(15) td:last-child');
                if (dueCell) {
                    const currentDue = newPaid + newRemaining; // ุงููุจูุบ ุงููุณุชุญู ุงูุฌุฏูุฏ ุจูุงุกู ุนูู ุงูุฏูุนุงุช
                    dueCell.innerHTML = `
                    <span class="new-value text-primary fw-bold">${number_format(originalAmountDue, 2)} ${currency}</span>
                    <small class="text-muted d-block">ุงููุฏููุน: ${number_format(newPaid, 2)} + ุงููุชุจูู: ${number_format(newRemaining, 2)}</small>
                `;
                }

                // ุฅุถุงูุฉ ุฃู ุชุญุฏูุซ CSS ููุชูุณูู
                if (!document.getElementById('payment-styles')) {
                    const style = document.createElement('style');
                    style.id = 'payment-styles';
                    style.textContent = `
                    .original-value {
                        text-decoration: line-through;
                        color: #777;
                        font-size: 0.85em;
                        margin-right: 8px;
                        opacity: 0.7;
                    }
                    .new-value {
                        font-weight: bold;
                        color: #0d6efd;
                    }
                    .new-value.text-success {
                        color: #198754 !important;
                    }
                    .new-value.text-warning {
                        color: #ffc107 !important;
                    }
                    .payment-updated {
                        background-color: #f8f9fa;
                        border-left: 4px solid #0d6efd;
                        animation: highlightPayment 2s ease-in-out;
                    }
                    @keyframes highlightPayment {
                        0% { background-color: #e3f2fd; }
                        50% { background-color: #bbdefb; }
                        100% { background-color: #f8f9fa; }
                    }
                `;
                    document.head.appendChild(style);
                }

                // ุฅุถุงูุฉ ุชุฃุซูุฑ ุจุตุฑู ููุตููู ุงููุญุฏุซุฉ
                setTimeout(() => {
                    if (paidCell) paidCell.closest('tr').classList.add('payment-updated');
                    if (remainingCell) remainingCell.closest('tr').classList.add('payment-updated');
                    if (dueCell) dueCell.closest('tr').classList.add('payment-updated');
                }, 500);
            }

            // ุฏุงูุฉ ุชูุณูู ุงูุฃุฑูุงู
            function number_format(number, decimals = 2) {
                return parseFloat(number).toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            // ุฏุงูุฉ ุนุฑุถ ุงูุฅุดุนุงุฑุงุช
            function showAlert(message, type) {
                // ุฅุฒุงูุฉ ุฃู ุชูุจููุงุช ููุฌูุฏุฉ
                const existingAlerts = document.querySelectorAll('.custom-alert');
                existingAlerts.forEach(alert => alert.remove());

                const alertBox = document.createElement('div');
                alertBox.className = `alert alert-${type} custom-alert`;
                alertBox.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    <span>${message}</span>
                </div>
            `;
                alertBox.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border: none;
                border-radius: 8px;
            `;

                document.body.appendChild(alertBox);

                setTimeout(() => {
                    alertBox.remove();
                }, 5000);
            }

            // ุงูุชุนุงูู ูุน ุฑุณุงุฆู ุงููุฌุงุญ ุฃู ุงูุฎุทุฃ ูู ุงูุฎุงุฏู ุจุนุฏ ุงูุชุญููู
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('payment_success')) {
                showAlert('ุชู ุชุณุฌูู ุงูุฏูุนุฉ ุจูุฌุงุญ! ุชู ุชุญุฏูุซ ุงููุจุงูุบ.', 'success');

                // ุชุญุฏูุซ ุงูุตูุญุฉ ุจุนุฏ 2 ุซุงููุฉ ูุฅุธูุงุฑ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 2000);
            } else if (urlParams.has('payment_error')) {
                showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุฏูุนุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.', 'danger');
            }

            // ุฅุถุงูุฉ ูุณุชูุน ูุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ ุนูุฏ ุฅุบูุงู ุงูููุฏุงู
            const paymentModal = document.getElementById('registerPaymentModal');
            if (paymentModal) {
                paymentModal.addEventListener('hidden.bs.modal', function() {
                    // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
                    const form = document.getElementById('paymentForm');
                    if (form) {
                        form.reset();
                    }
                });
            }
        });
    </script>
    <div class="modal fade" id="registerPaymentModal" tabindex="-1">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <form id="paymentForm" action="{{ route('bookings.record-payment', $booking->id) }}" method="POST">
                    @csrf
                    <input type="hidden" name="booking_id" value="{{ $booking->id }}">
                    <input type="hidden" name="company_id" value="{{ $booking->company->id ?? 0 }}">

                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-credit-card me-2"></i>
                            ุชุณุฌูู ุฏูุนุฉ - {{ $booking->company->name ?? 'ุบูุฑ ูุญุฏุฏ' }}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <!-- ุญูู ุฅุฏุฎุงู ุงููุจูุบ ูุงูุนููุฉ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-money-bill-wave text-success me-2"></i>
                                ุงููุจูุบ ุงููุฏููุน ูุงูุนููุฉ
                            </label>
                            <div class="input-group input-group-lg">
                                <input type="number" step="0.01"
                                    class="form-control form-control-lg text-center fw-bold" id="payment-amount"
                                    name="amount" placeholder="ุฃุฏุฎู ุงููุจูุบ" required>
                                <select class="form-select form-select-lg fw-bold text-center" name="currency"
                                    id="payment-currency" style="max-width: 140px;">
                                    <option value="SAR" {{ $booking->currency === 'SAR' ? 'selected' : '' }}>
                                        ุฑูุงู ุณุนูุฏู
                                    </option>
                                    <option value="KWD" {{ $booking->currency === 'KWD' ? 'selected' : '' }}>
                                        ุฏููุงุฑ ูููุชู
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- ุญูู ุงูููุงุญุธุงุช -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-sticky-note text-warning me-2"></i>
                                ููุงุญุธุงุช (ุงุฎุชูุงุฑู)
                            </label>
                            <textarea class="form-control" id="payment-notes" name="notes" rows="3"
                                placeholder="ุฃุถู ุฃู ููุงุญุธุงุช ุฎุงุตุฉ ุจุงูุฏูุนุฉ..."></textarea>
                        </div>



                        <!-- ููุฎุต ุงููุจุงูุบ -->
                        <div class="card border-primary shadow-sm">
                            <div class="card-header bg-primary text-white py-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    ููุฎุต ุงููุจุงูุบ ุงูุญุงููุฉ
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center py-1">
                                            <span class="text-muted">
                                                <i class="fas fa-dollar-sign text-primary me-1"></i>
                                                ุงููุจูุบ ุงูุฃุตูู:
                                            </span>
                                            <span class="fw-bold text-primary">
                                                {{ number_format($booking->amount_due_from_company, 2) }}
                                                {{ $booking->currency === 'SAR' ? 'ุฑูุงู' : 'ุฏููุงุฑ' }}
                                            </span>
                                        </div>
                                        <hr class="my-1">
                                    </div>

                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center py-1">
                                            <span class="text-muted">
                                                <i class="fas fa-check-circle text-success me-1"></i>
                                                ุงููุฏููุน ุณุงุจูุงู:(ูุฏ ูุนุฏููู ุงูุงุฏูู)
                                            </span>
                                            <span class="fw-bold text-success">
                                                {{ number_format($booking->amount_paid_by_company, 2) }}
                                                {{ $booking->currency === 'SAR' ? 'ุฑูุงู' : 'ุฏููุงุฑ' }}
                                            </span>
                                        </div>
                                        <hr class="my-1">
                                    </div>

                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center py-1">
                                            <span class="text-muted">
                                                <i class="fas fa-clock text-warning me-1"></i>
                                                ุงููุชุจูู:
                                            </span>
                                            <span class="fw-bold text-warning">
                                                {{ number_format($booking->amount_due_from_company - $booking->amount_paid_by_company, 2) }}
                                                {{ $booking->currency === 'SAR' ? 'ุฑูุงู' : 'ุฏููุงุฑ' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            ุฅุบูุงู
                        </button>
                        <button type="submit" class="btn btn-primary px-4" id="submit-payment">
                            <i class="fas fa-save me-1"></i>
                            ุชุณุฌูู ุงูุฏูุนุฉ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {{--  --}}
    <!-- ===== Modal ุงููุชุงุจุนุฉ ุงููุงููุฉ ููุญุฌุฒ ===== -->
    <div class="modal fade" id="financialTrackingModal" tabindex="-1" aria-labelledby="financialTrackingModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl"> <!-- ุงุณุชุฎุฏุงู modal-xl ููุญุตูู ุนูู ูุณุงุญุฉ ุฃูุจุฑ -->
            <div class="modal-content">
                <!-- Header ุงูู Modal -->
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="financialTrackingModalLabel">
                        <i class="fas fa-chart-line me-2"></i>
                        ูุชุงุจุนุฉ ุงููุนุงููุงุช ุงููุงููุฉ ููุญุฌุฒ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="ุฅุบูุงู"></button>
                </div>

                <!-- Body ุงูู Modal -->
                <div class="modal-body">
                    <!-- ุดุงุดุฉ ุงูุชุญููู -->
                    <div id="financialTrackingLoader" class="text-center py-5">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">ุฌุงุฑู ุงูุชุญููู...</span>
                        </div>
                        <p class="mt-3 text-muted">ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงููุชุงุจุนุฉ ุงููุงููุฉ...</p>
                    </div>

                    <!-- ูุญุชูู ุงููุชุงุจุนุฉ ุงููุงููุฉ -->
                    <div id="financialTrackingContent" style="display: none;">
                        <!-- ูุนูููุงุช ุงูุญุฌุฒ ุงูุฃุณุงุณูุฉ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-info-circle me-2"></i>
                                            ูุนูููุงุช ุงูุญุฌุฒ
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <strong>ุฑูู ุงููุงูุชุดุฑ:</strong>
                                                <span id="bookingVoucherNumber">-</span>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>ุงุณู ุงูุนููู:</strong>
                                                <span id="bookingClientName">-</span>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>ุชุงุฑูุฎ ุงูุฏุฎูู:</strong>
                                                <span id="bookingCheckIn">-</span>
                                                <div class="text-muted small" id="bookingCheckInHijri"></div>

                                            </div>
                                            <div class="col-md-3">
                                                <strong>ุชุงุฑูุฎ ุงูุฎุฑูุฌ:</strong>
                                                <span id="bookingCheckOut">-</span>
                                                <div class="text-muted small" id="bookingCheckOutHijri"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ูููุฐุฌ ุงููุชุงุจุนุฉ ุงููุงููุฉ -->
                        <form id="financialTrackingForm">
                            @csrf
                            <div class="row">
                                <!-- ุงููุตู ุงูุฃููู: ุฌูุฉ ุงูุญุฌุฒ -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-building me-2"></i>
                                                ุฌูุฉ ุงูุญุฌุฒ: <span id="agentName">-</span>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- ุงููุจูุบ ุงููุณุชุญู -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold text-primary">
                                                    <i class="fas fa-dollar-sign me-1"></i>
                                                    ุงููุจูุบ ุงููุณุชุญู
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text bg-primary text-white"
                                                        id="agentCurrency">USD</span>
                                                    <input type="text" class="form-control bg-light"
                                                        id="agentAmountDue" readonly>
                                                </div>
                                            </div>

                                            <!-- ุญุงูุฉ ุงูุณุฏุงุฏ -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold text-primary">
                                                    <i class="fas fa-clipboard-check me-1"></i>
                                                    ุญุงูุฉ ุงูุณุฏุงุฏ
                                                </label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio"
                                                        name="agent_payment_status" id="agentNotPaid" value="not_paid"
                                                        checked>
                                                    <label class="form-check-label text-danger" for="agentNotPaid">
                                                        <i class="fas fa-times-circle me-1"></i>
                                                        ูู ูุชู ุงูุณุฏุงุฏ
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio"
                                                        name="agent_payment_status" id="agentPartiallyPaid"
                                                        value="partially_paid">
                                                    <label class="form-check-label text-warning" for="agentPartiallyPaid">
                                                        <i class="fas fa-clock me-1"></i>
                                                        ุชู ุงูุชุญุตูู ุฌุฒุฆูุงู
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio"
                                                        name="agent_payment_status" id="agentFullyPaid"
                                                        value="fully_paid">
                                                    <label class="form-check-label text-success" for="agentFullyPaid">
                                                        <i class="fas fa-check-circle me-1"></i>
                                                        ุชู ุงูุชุญุตูู ุจุงููุงูู
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- ุงููุจูุบ ุงููุฏููุน -->
                                            <div class="mb-3" id="agentPaymentAmountGroup" style="display: none;">
                                                <label for="agentPaymentAmount" class="form-label fw-bold text-primary">
                                                    <i class="fas fa-money-bill-wave me-1"></i>
                                                    ุงููุจูุบ ุงููุฏููุน
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text bg-success text-white"
                                                        id="agentPaymentCurrency">USD</span>
                                                    <input type="number" step="0.01" min="0"
                                                        class="form-control" id="agentPaymentAmount"
                                                        name="agent_payment_amount" placeholder="0.00">
                                                </div>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    ุงููุณุจุฉ ุงููุฏููุนุฉ: <span id="agentPaymentPercentage"
                                                        class="fw-bold">0%</span>
                                                </div>
                                            </div>

                                            <!-- ููุงุญุธุงุช ุฌูุฉ ุงูุญุฌุฒ -->
                                            <div class="mb-3">
                                                <label for="agentPaymentNotes" class="form-label fw-bold text-primary">
                                                    <i class="fas fa-sticky-note me-1"></i>
                                                    ููุงุญุธุงุช
                                                </label>
                                                <textarea class="form-control" id="agentPaymentNotes" name="agent_payment_notes" rows="3"
                                                    placeholder="ุฃุถู ููุงุญุธุงุชู ุญูู ุงูุณุฏุงุฏ ูู ุฌูุฉ ุงูุญุฌุฒ..."></textarea>
                                            </div>

                                            <!-- ูุคุดุฑ ุจุตุฑู ูุญุงูุฉ ุงูุณุฏุงุฏ -->
                                            <div class="progress mb-2">
                                                <div class="progress-bar" id="agentProgressBar" role="progressbar"
                                                    style="width: 0%" aria-valuenow="0" aria-valuemin="0"
                                                    aria-valuemax="100">
                                                    0%
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                <i class="fas fa-chart-bar me-1"></i>
                                                ูุคุดุฑ ุชูุฏู ุงูุณุฏุงุฏ ูุฌูุฉ ุงูุญุฌุฒ
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- ุงููุตู ุงูุฃูุณุฑ: ุงูุดุฑูุฉ -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-success">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-briefcase me-2"></i>
                                                ุงูุดุฑูุฉ: <span id="companyName">-</span>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- ุงููุจูุบ ุงููุณุชุญู -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold text-success">
                                                    <i class="fas fa-dollar-sign me-1"></i>
                                                    ุงููุจูุบ ุงููุณุชุญู
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text bg-success text-white"
                                                        id="companyCurrency">USD</span>
                                                    <input type="text" class="form-control bg-light"
                                                        id="companyAmountDue" readonly>
                                                </div>
                                            </div>

                                            <!-- ุญุงูุฉ ุงูุณุฏุงุฏ -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold text-success">
                                                    <i class="fas fa-clipboard-check me-1"></i>
                                                    ุญุงูุฉ ุงูุณุฏุงุฏ
                                                </label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio"
                                                        name="company_payment_status" id="companyNotPaid"
                                                        value="not_paid" checked>
                                                    <label class="form-check-label text-danger" for="companyNotPaid">
                                                        <i class="fas fa-times-circle me-1"></i>
                                                        ูู ูุชู ุงูุณุฏุงุฏ
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio"
                                                        name="company_payment_status" id="companyPartiallyPaid"
                                                        value="partially_paid">
                                                    <label class="form-check-label text-warning"
                                                        for="companyPartiallyPaid">
                                                        <i class="fas fa-clock me-1"></i>
                                                        ุชู ุงูุชุญุตูู ุฌุฒุฆูุงู
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio"
                                                        name="company_payment_status" id="companyFullyPaid"
                                                        value="fully_paid">
                                                    <label class="form-check-label text-success" for="companyFullyPaid">
                                                        <i class="fas fa-check-circle me-1"></i>
                                                        ุชู ุงูุชุญุตูู ุจุงููุงูู
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- ุงููุจูุบ ุงููุฏููุน -->
                                            <div class="mb-3" id="companyPaymentAmountGroup" style="display: none;">
                                                <label for="companyPaymentAmount" class="form-label fw-bold text-success">
                                                    <i class="fas fa-money-bill-wave me-1"></i>
                                                    ุงููุจูุบ ุงููุฏููุน
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text bg-primary text-white"
                                                        id="companyPaymentCurrency">USD</span>
                                                    <input type="number" step="0.01" min="0"
                                                        class="form-control" id="companyPaymentAmount"
                                                        name="company_payment_amount" placeholder="0.00">
                                                </div>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    ุงููุณุจุฉ ุงููุฏููุนุฉ: <span id="companyPaymentPercentage"
                                                        class="fw-bold">0%</span>
                                                </div>
                                            </div>

                                            <!-- ููุงุญุธุงุช ุงูุดุฑูุฉ -->
                                            <div class="mb-3">
                                                <label for="companyPaymentNotes" class="form-label fw-bold text-success">
                                                    <i class="fas fa-sticky-note me-1"></i>
                                                    ููุงุญุธุงุช
                                                </label>
                                                <textarea class="form-control" id="companyPaymentNotes" name="company_payment_notes" rows="3"
                                                    placeholder="ุฃุถู ููุงุญุธุงุชู ุญูู ุงูุณุฏุงุฏ ูู ุงูุดุฑูุฉ..."></textarea>
                                            </div>

                                            <!-- ูุคุดุฑ ุจุตุฑู ูุญุงูุฉ ุงูุณุฏุงุฏ -->
                                            <div class="progress mb-2">
                                                <div class="progress-bar bg-success" id="companyProgressBar"
                                                    role="progressbar" style="width: 0%" aria-valuenow="0"
                                                    aria-valuemin="0" aria-valuemax="100">
                                                    0%
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                <i class="fas fa-chart-bar me-1"></i>
                                                ูุคุดุฑ ุชูุฏู ุงูุณุฏุงุฏ ููุดุฑูุฉ
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ุฅุนุฏุงุฏุงุช ุฅุถุงููุฉ -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="fas fa-cogs me-2"></i>
                                                ุฅุนุฏุงุฏุงุช ุงููุชุงุจุนุฉ
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <!-- ุชุงุฑูุฎ ุงูุงุณุชุญูุงู -->
                                                <div class="col-md-4">
                                                    <label for="paymentDeadline" class="form-label fw-bold">
                                                        <i class="fas fa-calendar-times me-1"></i>
                                                        ุชุงุฑูุฎ ุงูุงุณุชุญูุงู
                                                    </label>
                                                    <input type="date" class="form-control" id="paymentDeadline"
                                                        name="payment_deadline">
                                                    <div class="form-text">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู ุงููุชููุน ููุณุฏุงุฏ</div>
                                                </div>

                                                <!-- ุชุงุฑูุฎ ุงููุชุงุจุนุฉ ุงูุชุงูู -->
                                                <div class="col-md-4">
                                                    <label for="followUpDate" class="form-label fw-bold">
                                                        <i class="fas fa-calendar-check me-1"></i>
                                                        ุชุงุฑูุฎ ุงููุชุงุจุนุฉ ุงูุชุงูู
                                                    </label>
                                                    <input type="date" class="form-control" id="followUpDate"
                                                        name="follow_up_date">
                                                    <div class="form-text">ูุชู ูุฌุจ ูุชุงุจุนุฉ ูุฐุง ุงูุญุฌุฒ ูุฑุฉ ุฃุฎุฑู</div>
                                                </div>

                                                <!-- ูุณุชูู ุงูุฃููููุฉ -->
                                                <div class="col-md-4">
                                                    <label for="priorityLevel" class="form-label fw-bold">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        ูุณุชูู ุงูุฃููููุฉ
                                                    </label>
                                                    <select class="form-select" id="priorityLevel" name="priority_level">
                                                        <option value="low" class="text-muted">
                                                            <i class="fas fa-arrow-down"></i> ููุฎูุถุฉ
                                                        </option>
                                                        <option value="medium" selected class="text-primary">
                                                            <i class="fas fa-minus"></i> ูุชูุณุทุฉ
                                                        </option>
                                                        <option value="high" class="text-danger">
                                                            <i class="fas fa-arrow-up"></i> ุนุงููุฉ
                                                        </option>
                                                    </select>
                                                    <div class="form-text">ูุณุชูู ุฃููููุฉ ูุชุงุจุนุฉ ูุฐุง ุงูุญุฌุฒ</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ููุฎุต ุงูุญุงูุฉ ุงูุญุงููุฉ -->
                            <div class="row mt-4" id="currentStatusSummary" style="display: none;">
                                <div class="col-12">
                                    <div class="card border-info">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-clipboard-list me-2"></i>
                                                ููุฎุต ุงูุญุงูุฉ ุงูุญุงููุฉ
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <i class="fas fa-building text-primary me-2"></i>
                                                        <strong>ุฌูุฉ ุงูุญุฌุฒ:</strong>
                                                        <span id="summaryAgentStatus" class="ms-2 badge">-</span>
                                                    </div>
                                                    <div class="text-muted small" id="summaryAgentDetails">-</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <i class="fas fa-briefcase text-success me-2"></i>
                                                        <strong>ุงูุดุฑูุฉ:</strong>
                                                        <span id="summaryCompanyStatus" class="ms-2 badge">-</span>
                                                    </div>
                                                    <div class="text-muted small" id="summaryCompanyDetails">-</div>
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-user me-1"></i>
                                                        ุขุฎุฑ ุชุญุฏูุซ ุจูุงุณุทุฉ: <span id="lastUpdatedBy">-</span>
                                                    </small>
                                                </div>
                                                <div class="col-md-6 text-end">
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock me-1"></i>
                                                        ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ: <span id="lastUpdatedDate">-</span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </form>
                    </div>

                    <!-- ุฑุณุงุฆู ุงูุฎุทุฃ -->
                    <div id="financialTrackingError" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="financialTrackingErrorMessage">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช</span>
                    </div>
                </div>

                <!-- Footer ุงูู Modal -->
                <div class="modal-footer bg-light">
                    <div class="d-flex justify-content-between w-100">
                        <!-- ูุนูููุงุช ุฅุถุงููุฉ -->
                        <div class="text-muted small">
                            <i class="fas fa-info-circle me-1"></i>
                            ุฌููุน ุงูุชุบููุฑุงุช ูุชู ุญูุธูุง ุชููุงุฆูุงู
                        </div>

                        <!-- ุฃุฒุฑุงุฑ ุงูุญูุธ ูุงูุฅูุบุงุก -->
                        <div>
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>
                                ุฅุบูุงู
                            </button>
                            <button type="button" class="btn btn-success" id="saveFinancialTracking">
                                <i class="fas fa-save me-1"></i>
                                ุญูุธ ุงููุชุงุจุนุฉ ุงููุงููุฉ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
@endsection
@push('scripts')
    <script>
        // ===== ูุชุบูุฑุงุช ุนุงูุฉ ูููุชุงุจุนุฉ ุงููุงููุฉ =====
        let currentBookingId = null;
        let currentTrackingData = null;
        let isLoadingFinancialData = false;

        /**
         * ุชุญููู ุจูุงูุงุช ุงููุชุงุจุนุฉ ุงููุงููุฉ ููุญุฌุฒ
         * 
         * @param {number} bookingId ูุนุฑู ุงูุญุฌุฒ
         */
        function loadFinancialTracking(bookingId) {
            console.log('๐ ุจุฏุก ุชุญููู ุงููุชุงุจุนุฉ ุงููุงููุฉ ููุญุฌุฒ:', bookingId);

            currentBookingId = bookingId;

            // ุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู
            showFinancialTrackingLoader();

            // ูุณุญ ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ
            hideFinancialTrackingError();

            // ุฅุฑุณุงู ุทูุจ AJAX ูุชุญููู ุงูุจูุงูุงุช
            isLoadingFinancialData = true;

            fetch(`/bookings/${bookingId}/financial-tracking`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('โ ุชู ุชุญููู ุจูุงูุงุช ุงููุชุงุจุนุฉ ุงููุงููุฉ ุจูุฌุงุญ:', data);

                    if (data.success) {
                        currentTrackingData = data;
                        populateFinancialTrackingForm(data);
                        showFinancialTrackingContent();
                    } else {
                        throw new Error(data.error || 'ูุดู ูู ุชุญููู ุงูุจูุงูุงุช');
                    }
                })
                .catch(error => {
                    console.error('โ ุฎุทุฃ ูู ุชุญููู ุงููุชุงุจุนุฉ ุงููุงููุฉ:', error);
                    showFinancialTrackingError(error.message || 'ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช');
                })
                .finally(() => {
                    isLoadingFinancialData = false;
                    hideFinancialTrackingLoader();
                });
        }

        /**
         * ููุก ูููุฐุฌ ุงููุชุงุจุนุฉ ุงููุงููุฉ ุจุงูุจูุงูุงุช ุงููุญููุฉ
         * 
         * @param {object} data ุงูุจูุงูุงุช ุงููุญููุฉ ูู ุงูุฎุงุฏู
         */
        function populateFinancialTrackingForm(data) {
            console.log('๐ ููุก ูููุฐุฌ ุงููุชุงุจุนุฉ ุงููุงููุฉ ุจุงูุจูุงูุงุช:', data);

            try {
                // ===== ููุก ูุนูููุงุช ุงูุญุฌุฒ ุงูุฃุณุงุณูุฉ =====
                document.getElementById('bookingVoucherNumber').textContent = data.booking.id || '-';
                document.getElementById('bookingClientName').textContent = data.booking.client_name || '-';
                // ุชุนุจุฆุฉ ุชุงุฑูุฎ ุงูุฏุฎูู ุจุงูุชุงุฑูุฎ ุงููููุงุฏู
                // document.getElementById('bookingCheckIn').textContent = formatDate(data.booking.check_in);
                // ุชุนุจุฆุฉ ุชุงุฑูุฎ ุงูุฏุฎูู ุจุงูุชุงุฑูุฎ ุงููููุงุฏู ูุงููุฌุฑู
                const checkInDate = new Date(data.booking.check_in);

                // ุนุฑุถ ุงูุชุงุฑูุฎ ุงููููุงุฏู ุจุตูุบุฉ dd/mm/yyyy ุจุบุถ ุงููุธุฑ ุนู ุฅุนุฏุงุฏุงุช ุงููุธุงู
                document.getElementById('bookingCheckIn').textContent = checkInDate.toLocaleDateString('en-GB', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                // ุชุนุจุฆุฉ ุชุงุฑูุฎ ุงูุฏุฎูู ุจุงูุชุงุฑูุฎ ุงููุฌุฑู
                document.getElementById('bookingCheckInHijri').textContent = formatHijriDate(new Date(data.booking
                    .check_in));

                // ุชุนุจุฆุฉ ุชุงุฑูุฎ ุงูุฎุฑูุฌ ุจุงูุชุงุฑูุฎ ุงููููุงุฏู ูุงููุฌุฑู
                const checkOutDate = new Date(data.booking.check_out);

                // ุนุฑุถ ุงูุชุงุฑูุฎ ุงููููุงุฏู ุจุตูุบุฉ dd/mm/yyyy ุจุบุถ ุงููุธุฑ ุนู ุฅุนุฏุงุฏุงุช ุงููุธุงู
                document.getElementById('bookingCheckOut').textContent = checkOutDate.toLocaleDateString('en-GB', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });


                // ุชุนุจุฆุฉ ุชุงุฑูุฎ ุงูุฎุฑูุฌ ุจุงูุชุงุฑูุฎ ุงููุฌุฑู
                document.getElementById('bookingCheckOutHijri').textContent = formatHijriDate(new Date(data.booking
                    .check_out));

                // ===== ููุก ุจูุงูุงุช ุฌูุฉ ุงูุญุฌุฒ =====
                document.getElementById('agentName').textContent = data.booking.agent.name;
                // id : hotel-due-value
                document.getElementById('agentAmountDue').value = formatNumber(data.booking.agent.amount_due);
                document.getElementById('agentCurrency').textContent = data.booking.currency;
                document.getElementById('agentPaymentCurrency').textContent = data.booking.currency;

                // ุชุญุฏูุฏ ุญุงูุฉ ุงูุณุฏุงุฏ ูุฌูุฉ ุงูุญุฌุฒ
                const agentStatus = data.tracking.agent_payment_status;
                document.querySelector(`input[name="agent_payment_status"][value="${agentStatus}"]`).checked = true;

                // ููุก ุงููุจูุบ ุงููุฏููุน ูุงูููุงุญุธุงุช ูุฌูุฉ ุงูุญุฌุฒ
                document.getElementById('agentPaymentAmount').value = data.tracking.agent_payment_amount || '';
                document.getElementById('agentPaymentNotes').value = data.tracking.agent_payment_notes || '';

                // ===== ููุก ุจูุงูุงุช ุงูุดุฑูุฉ =====
                document.getElementById('companyName').textContent = data.booking.company.name;
                document.getElementById('companyAmountDue').value = formatNumber(data.booking.company.amount_due);
                document.getElementById('companyCurrency').textContent = data.booking.currency;
                document.getElementById('companyPaymentCurrency').textContent = data.booking.currency;

                // ุชุญุฏูุฏ ุญุงูุฉ ุงูุณุฏุงุฏ ููุดุฑูุฉ
                const companyStatus = data.tracking.company_payment_status;
                document.querySelector(`input[name="company_payment_status"][value="${companyStatus}"]`).checked = true;

                // ููุก ุงููุจูุบ ุงููุฏููุน ูุงูููุงุญุธุงุช ููุดุฑูุฉ
                document.getElementById('companyPaymentAmount').value = data.tracking.company_payment_amount || '';
                document.getElementById('companyPaymentNotes').value = data.tracking.company_payment_notes || '';

                // ===== ููุก ุงูุฅุนุฏุงุฏุงุช ุงูุฅุถุงููุฉ =====
                document.getElementById('paymentDeadline').value = data.tracking.payment_deadline || '';
                document.getElementById('followUpDate').value = data.tracking.follow_up_date || '';
                document.getElementById('priorityLevel').value = data.tracking.priority_level || 'medium';

                // ===== ููุก ููุฎุต ุงูุญุงูุฉ ุงูุญุงููุฉ =====
                if (data.tracking.id) {
                    populateStatusSummary(data);
                    document.getElementById('currentStatusSummary').style.display = 'block';
                }

                // ===== ุชุญุฏูุซ ุงูุนูุงุตุฑ ุงูุชูุงุนููุฉ =====
                updatePaymentAmountVisibility();
                updateProgressBars();
                updateStatusLabels();

                console.log('โ ุชู ููุก ุงููููุฐุฌ ุจูุฌุงุญ');

            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ููุก ุงููููุฐุฌ:', error);
                showFinancialTrackingError('ุญุฏุซ ุฎุทุฃ ูู ุนุฑุถ ุงูุจูุงูุงุช');
            }
        }

        /**
         * ููุก ููุฎุต ุงูุญุงูุฉ ุงูุญุงููุฉ
         * 
         * @param {object} data ุงูุจูุงูุงุช ุงููุญููุฉ
         */
        function populateStatusSummary(data) {
            // ุญุงูุฉ ุฌูุฉ ุงูุญุฌุฒ
            const agentStrategy = data.strategies.agent;
            document.getElementById('summaryAgentStatus').className = `ms-2 badge bg-${agentStrategy.bootstrap_class}`;
            document.getElementById('summaryAgentStatus').textContent = agentStrategy.label;
            document.getElementById('summaryAgentDetails').textContent =
                `${formatNumber(data.tracking.agent_payment_amount)} ูู ${formatNumber(data.booking.agent.amount_due)} ${data.booking.currency} (${data.calculations.agent_payment_percentage}%)`;

            // ุญุงูุฉ ุงูุดุฑูุฉ
            const companyStrategy = data.strategies.company;
            document.getElementById('summaryCompanyStatus').className = `ms-2 badge bg-${companyStrategy.bootstrap_class}`;
            document.getElementById('summaryCompanyStatus').textContent = companyStrategy.label;
            document.getElementById('summaryCompanyDetails').textContent =
                `${formatNumber(data.tracking.company_payment_amount)} ูู ${formatNumber(data.booking.company.amount_due)} ${data.booking.currency} (${data.calculations.company_payment_percentage}%)`;

            // ูุนูููุงุช ุขุฎุฑ ุชุญุฏูุซ
            document.getElementById('lastUpdatedBy').textContent = data.tracking.last_updated_by || 'ุบูุฑ ูุนุฑูู';
            document.getElementById('lastUpdatedDate').textContent = formatDateTime(data.tracking.updated_at);
        }

        function validateFinancialTrackingForm() {
            // ุฌูุฉ ุงูุญุฌุฒ
            const agentStatus = document.querySelector('input[name="agent_payment_status"]:checked').value;
            const agentAmount = parseFloat(document.getElementById('agentPaymentAmount').value) || 0;
            const agentTotalDue = parseFloat(document.getElementById('agentAmountDue').value.replace(/,/g, '')) || 0;

            // ุงูุดุฑูุฉ
            const companyStatus = document.querySelector('input[name="company_payment_status"]:checked').value;
            const companyAmount = parseFloat(document.getElementById('companyPaymentAmount').value) || 0;
            const companyTotalDue = parseFloat(document.getElementById('companyAmountDue').value.replace(/,/g, '')) || 0;

            // ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุฌูุฉ ุงูุญุฌุฒ
            if (agentStatus === 'not_paid' && agentAmount > 0) {
                showFinancialTrackingError(
                    "ุญุงูุฉ ุงูุณุฏุงุฏ ูุฌูุฉ ุงูุญุฌุฒ 'ูู ูุชู ุงูุณุฏุงุฏ' ููู ุงููุจูุบ ุฃูุจุฑ ูู ุตูุฑ. ุงููุจูุบ ูุฌุจ ุฃู ูููู ุตูุฑ.");
                return false;
            }

            if (agentStatus === 'fully_paid' && Math.abs(agentAmount - agentTotalDue) > 0.01) {
                showFinancialTrackingError(
                    `ุญุงูุฉ ุงูุณุฏุงุฏ ูุฌูุฉ ุงูุญุฌุฒ 'ุชู ุงูุณุฏุงุฏ ุจุงููุงูู' ููู ุงููุจูุบ (${agentAmount}) ูุง ูุณุงูู ุงููุณุชุญู (${agentTotalDue}). ุณูุชู ุชุตุญูุญ ุงููุจูุบ ุชููุงุฆูุงู.`
                );
                document.getElementById('agentPaymentAmount').value = agentTotalDue.toFixed(2);
                return false;
            }

            if (agentStatus === 'partially_paid' && (agentAmount <= 0 || agentAmount >= agentTotalDue)) {
                showFinancialTrackingError(
                    `ุญุงูุฉ ุงูุณุฏุงุฏ ูุฌูุฉ ุงูุญุฌุฒ 'ุณุฏุงุฏ ุฌุฒุฆู' ููู ุงููุจูุบ ุบูุฑ ุตุญูุญ (${agentAmount}). ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ ูุฃูู ูู ${agentTotalDue}.`
                );
                return false;
            }

            // ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุงูุดุฑูุฉ
            if (companyStatus === 'not_paid' && companyAmount > 0) {
                showFinancialTrackingError(
                    "ุญุงูุฉ ุงูุณุฏุงุฏ ููุดุฑูุฉ 'ูู ูุชู ุงูุณุฏุงุฏ' ููู ุงููุจูุบ ุฃูุจุฑ ูู ุตูุฑ. ุงููุจูุบ ูุฌุจ ุฃู ูููู ุตูุฑ.");
                return false;
            }

            if (companyStatus === 'fully_paid' && Math.abs(companyAmount - companyTotalDue) > 0.01) {
                showFinancialTrackingError(
                    `ุญุงูุฉ ุงูุณุฏุงุฏ ููุดุฑูุฉ 'ุชู ุงูุณุฏุงุฏ ุจุงููุงูู' ููู ุงููุจูุบ (${companyAmount}) ูุง ูุณุงูู ุงููุณุชุญู (${companyTotalDue}). ุณูุชู ุชุตุญูุญ ุงููุจูุบ ุชููุงุฆูุงู.`
                );
                document.getElementById('companyPaymentAmount').value = companyTotalDue.toFixed(2);
                return false;
            }

            if (companyStatus === 'partially_paid' && (companyAmount <= 0 || companyAmount >= companyTotalDue)) {
                showFinancialTrackingError(
                    `ุญุงูุฉ ุงูุณุฏุงุฏ ููุดุฑูุฉ 'ุณุฏุงุฏ ุฌุฒุฆู' ููู ุงููุจูุบ ุบูุฑ ุตุญูุญ (${companyAmount}). ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ ูุฃูู ูู ${companyTotalDue}.`
                );
                return false;
            }

            // ุงูุชุญูู ูู ุงูุชูุงุฑูุฎ
            const paymentDeadline = document.getElementById('paymentDeadline').value;
            const followUpDate = document.getElementById('followUpDate').value;
            const today = new Date().toISOString().split('T')[0];

            if (paymentDeadline && paymentDeadline <= today) {
                showFinancialTrackingError("ุชุงุฑูุฎ ุงูุงุณุชุญูุงู ูุฌุจ ุฃู ูููู ูู ุงููุณุชูุจู.");
                return false;
            }

            if (followUpDate && followUpDate <= today) {
                showFinancialTrackingError("ุชุงุฑูุฎ ุงููุชุงุจุนุฉ ูุฌุจ ุฃู ูููู ูู ุงููุณุชูุจู.");
                return false;
            }

            return true;
        }

        /**
         * ุชุญุฏูุซ ุฑุคูุฉ ุญููู ุงููุจูุบ ุงููุฏููุน ุญุณุจ ุญุงูุฉ ุงูุณุฏุงุฏ
         */
        function updatePaymentAmountVisibility() {
            console.log('๐ ุชุญุฏูุซ ุฑุคูุฉ ุญููู ุงููุจูุบ ุงููุฏููุน');

            // ุฌูุฉ ุงูุญุฌุฒ
            const agentStatus = document.querySelector('input[name="agent_payment_status"]:checked').value;
            const agentAmountGroup = document.getElementById('agentPaymentAmountGroup');
            const agentAmountInput = document.getElementById('agentPaymentAmount');
            const totalAgentDue = parseFloat(document.getElementById('agentAmountDue').value.replace(/,/g, '')) || 0;

            if (agentStatus === 'not_paid') {
                agentAmountGroup.style.display = 'none';
                agentAmountInput.value = '0'; // ุชุฃูุฏ ูู ุฃู ุงููููุฉ ุตูุฑ ุนูุฏ "ูู ูุชู ุงูุณุฏุงุฏ"
            } else {
                agentAmountGroup.style.display = 'block';
                if (agentStatus === 'fully_paid') {
                    agentAmountInput.value = totalAgentDue.toFixed(2); // ุชุฃูุฏ ูู ุงููุณุงูุงุฉ ุงูุชุงูุฉ ูููุจูุบ ุงููุณุชุญู
                } else if (agentStatus === 'partially_paid') {
                    // ููุณุฏุงุฏ ุงูุฌุฒุฆู: ุฅุฐุง ูุงู ุงููุจูุบ ุตูุฑ ุฃู ูุณุงูู ุงููุจูุบ ุงููููุ ุงุฌุนูู ูุตู ุงููุจูุบ ูุงูุชุฑุงุถู
                    const currentAmount = parseFloat(agentAmountInput.value) || 0;
                    if (currentAmount <= 0 || currentAmount >= totalAgentDue) {
                        agentAmountInput.value = (totalAgentDue / 2).toFixed(2);
                    }
                }
            }

            // ุงูุดุฑูุฉ - ููุณ ุงูููุทู
            const companyStatus = document.querySelector('input[name="company_payment_status"]:checked').value;
            const companyAmountGroup = document.getElementById('companyPaymentAmountGroup');
            const companyAmountInput = document.getElementById('companyPaymentAmount');
            const totalCompanyDue = parseFloat(document.getElementById('companyAmountDue').value.replace(/,/g, '')) || 0;

            if (companyStatus === 'not_paid') {
                companyAmountGroup.style.display = 'none';
                companyAmountInput.value = '0'; // ุชุฃูุฏ ูู ุฃู ุงููููุฉ ุตูุฑ ุนูุฏ "ูู ูุชู ุงูุณุฏุงุฏ"
            } else {
                companyAmountGroup.style.display = 'block';
                if (companyStatus === 'fully_paid') {
                    companyAmountInput.value = totalCompanyDue.toFixed(2); // ุชุฃูุฏ ูู ุงููุณุงูุงุฉ ุงูุชุงูุฉ ูููุจูุบ ุงููุณุชุญู
                } else if (companyStatus === 'partially_paid') {
                    // ููุณุฏุงุฏ ุงูุฌุฒุฆู: ุฅุฐุง ูุงู ุงููุจูุบ ุตูุฑ ุฃู ูุณุงูู ุงููุจูุบ ุงููููุ ุงุฌุนูู ูุตู ุงููุจูุบ ูุงูุชุฑุงุถู
                    const currentAmount = parseFloat(companyAmountInput.value) || 0;
                    if (currentAmount <= 0 || currentAmount >= totalCompanyDue) {
                        companyAmountInput.value = (totalCompanyDue / 2).toFixed(2);
                    }
                }
            }

            // ุชุญุฏูุซ ุฃุดุฑุทุฉ ุงูุชูุฏู
            updateProgressBars();
        }

        /**
         * ุชุญุฏูุซ ุฃุดุฑุทุฉ ุงูุชูุฏู ูุงููุณุจ ุงููุฆููุฉ
         */
        function updateProgressBars() {
            console.log('๐ ุชุญุฏูุซ ุฃุดุฑุทุฉ ุงูุชูุฏู');

            // ุดุฑูุท ุชูุฏู ุฌูุฉ ุงูุญุฌุฒ
            const agentPaid = parseFloat(document.getElementById('agentPaymentAmount').value) || 0;
            const agentTotal = parseFloat(document.getElementById('agentAmountDue').value.replace(/,/g, '')) || 0;
            const agentPercentage = agentTotal > 0 ? Math.round((agentPaid / agentTotal) * 100) : 0;

            const agentProgressBar = document.getElementById('agentProgressBar');
            agentProgressBar.style.width = `${agentPercentage}%`;
            agentProgressBar.textContent = `${agentPercentage}%`;
            agentProgressBar.setAttribute('aria-valuenow', agentPercentage);

            // ุชุบููุฑ ููู ุงูุดุฑูุท ุญุณุจ ุงููุณุจุฉ
            agentProgressBar.className = 'progress-bar';
            if (agentPercentage === 100) {
                agentProgressBar.classList.add('bg-success');
            } else if (agentPercentage > 0) {
                agentProgressBar.classList.add('bg-warning');
            } else {
                agentProgressBar.classList.add('bg-danger');
            }

            document.getElementById('agentPaymentPercentage').textContent = `${agentPercentage}%`;

            // ุดุฑูุท ุชูุฏู ุงูุดุฑูุฉ
            const companyPaid = parseFloat(document.getElementById('companyPaymentAmount').value) || 0;
            const companyTotal = parseFloat(document.getElementById('companyAmountDue').value.replace(/,/g, '')) || 0;
            const companyPercentage = companyTotal > 0 ? Math.round((companyPaid / companyTotal) * 100) : 0;

            const companyProgressBar = document.getElementById('companyProgressBar');
            companyProgressBar.style.width = `${companyPercentage}%`;
            companyProgressBar.textContent = `${companyPercentage}%`;
            companyProgressBar.setAttribute('aria-valuenow', companyPercentage);

            // ููู ุงูุดุฑูุท ุซุงุจุช ููุดุฑูุฉ (ุฃุฎุถุฑ)
            companyProgressBar.className = 'progress-bar bg-success';

            document.getElementById('companyPaymentPercentage').textContent = `${companyPercentage}%`;
        }

        /**
         * ุชุญุฏูุซ ุชุณููุงุช ุงูุญุงูุฉ ูุงูุฃููุงู
         */
        function updateStatusLabels() {
            console.log('๐จ ุชุญุฏูุซ ุชุณููุงุช ุงูุญุงูุฉ');

            // ูููู ุฅุถุงูุฉ ุชุญุฏูุซุงุช ุฅุถุงููุฉ ููุฃููุงู ูุงูุชุณููุงุช ููุง
            // ูุซู ุชุบููุฑ ููู ุงูุจุทุงูุงุช ุญุณุจ ุงูุญุงูุฉ
        }

        /**
         * ุญูุธ ุจูุงูุงุช ุงููุชุงุจุนุฉ ุงููุงููุฉ
         */
        function saveFinancialTracking() {
            console.log('๐พ ุจุฏุก ุญูุธ ุงููุชุงุจุนุฉ ุงููุงููุฉ');

            if (!currentBookingId) {
                showFinancialTrackingError('ูุนุฑู ุงูุญุฌุฒ ุบูุฑ ุตุญูุญ');
                return;
            }

            // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ูุจู ุงูุฅุฑุณุงู
            if (!validateFinancialTrackingForm()) {
                return;
            }

            // ุฌูุน ุงูุจูุงูุงุช ุงููุฏููุฉ ุจุดูู ุชูุตููู
            const oldData = {
                agent: {
                    status: document.querySelector('input[name="agent_payment_status"]:checked').value,
                    statusLabel: getStatusLabel(document.querySelector('input[name="agent_payment_status"]:checked')
                        .value),
                    amount: parseFloat(document.getElementById('agentPaymentAmount').value) || 0,
                    notes: document.getElementById('agentPaymentNotes').value,
                    amountFormatted: formatNumber(parseFloat(document.getElementById('agentPaymentAmount').value) || 0)
                },
                company: {
                    status: document.querySelector('input[name="company_payment_status"]:checked').value,
                    statusLabel: getStatusLabel(document.querySelector('input[name="company_payment_status"]:checked')
                        .value),
                    amount: parseFloat(document.getElementById('companyPaymentAmount').value) || 0,
                    notes: document.getElementById('companyPaymentNotes').value,
                    amountFormatted: formatNumber(parseFloat(document.getElementById('companyPaymentAmount').value) ||
                        0)
                },
                settings: {
                    priority: document.getElementById('priorityLevel').value,
                    priorityLabel: getPriorityLabel(document.getElementById('priorityLevel').value),
                    payment_deadline: document.getElementById('paymentDeadline').value,
                    follow_up_date: document.getElementById('followUpDate').value
                }
            };

            console.log('๐ ุงูุจูุงูุงุช ุงููุฏููุฉ ุงูููุตูุฉ:', oldData);

            // ุชุฌููุฒ ุจูุงูุงุช ุงููููุฐุฌ ุงูุฌุฏูุฏุฉ
            const formElement = document.getElementById('financialTrackingForm');
            const formData = new FormData(formElement);

            // ุฌูุน ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ุจุดูู ุชูุตููู
            const newData = {
                agent: {
                    status: formData.get('agent_payment_status'),
                    statusLabel: getStatusLabel(formData.get('agent_payment_status')),
                    amount: parseFloat(formData.get('agent_payment_amount')) || 0,
                    notes: formData.get('agent_payment_notes') || '',
                    amountFormatted: formatNumber(parseFloat(formData.get('agent_payment_amount')) || 0)
                },
                company: {
                    status: formData.get('company_payment_status'),
                    statusLabel: getStatusLabel(formData.get('company_payment_status')),
                    amount: parseFloat(formData.get('company_payment_amount')) || 0,
                    notes: formData.get('company_payment_notes') || '',
                    amountFormatted: formatNumber(parseFloat(formData.get('company_payment_amount')) || 0)
                },
                settings: {
                    priority: formData.get('priority_level') || 'medium',
                    priorityLabel: getPriorityLabel(formData.get('priority_level') || 'medium'),
                    payment_deadline: formData.get('payment_deadline') || '',
                    follow_up_date: formData.get('follow_up_date') || ''
                }
            };

            console.log('๐ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ุงูููุตูุฉ:', newData);

            // ูุนูููุงุช ุนุงูุฉ ููุชุณุฌูู
            const currency = document.getElementById('agentCurrency').textContent || '';
            const userName = "{{ Auth::user()->name }}";
            const now = new Date();
            const timestamp = now.toLocaleDateString('ar-SA') + ' ' + now.toLocaleTimeString('ar-SA');

            // ===== ุฅูุดุงุก ุณุฌู ุชูุตููู ููุชุบููุฑุงุช =====
            let changeLog = '';
            let hasChanges = false;

            // ----- ููุงุฑูุฉ ุจูุงูุงุช ุฌูุฉ ุงูุญุฌุฒ -----
            let agentChanges = '';

            // ููุงุฑูุฉ ุญุงูุฉ ุงูุณุฏุงุฏ
            if (oldData.agent.status !== newData.agent.status) {
                agentChanges += `โข ุชุบููุฑ ุญุงูุฉ ุงูุณุฏุงุฏ: ${oldData.agent.statusLabel} โ๏ธ ${newData.agent.statusLabel}\n`;
                hasChanges = true;
            }

            // ููุงุฑูุฉ ุงููุจูุบ ุงููุฏููุน
            if (Math.abs(oldData.agent.amount - newData.agent.amount) > 0.01) {
                const diff = newData.agent.amount - oldData.agent.amount;
                const diffSymbol = diff > 0 ? 'โฒ' : 'โผ';
                const totalDue = parseFloat(document.getElementById('agentAmountDue').value.replace(/,/g, '')) || 0;
                const newPercentage = totalDue > 0 ? Math.round((newData.agent.amount / totalDue) * 100) : 0;

                agentChanges +=
                    `โข ุชุบููุฑ ุงููุจูุบ ุงููุฏููุน: ${oldData.agent.amountFormatted} ${currency} โ๏ธ ${newData.agent.amountFormatted} ${currency}\n`;
                agentChanges +=
                    `  ${diffSymbol} ${diff > 0 ? 'ุฒูุงุฏุฉ' : 'ููุต'} ุจููุฏุงุฑ ${Math.abs(diff).toFixed(2)} ${currency}\n`;
                agentChanges += `โข ุงููุณุจุฉ ุงููุฆููุฉ ุงูุฌุฏูุฏุฉ ููุณุฏุงุฏ: ${newPercentage}%\n`;
                hasChanges = true;
            }

            // ุฅุถุงูุฉ ุณุฌู ุชุบููุฑุงุช ุฌูุฉ ุงูุญุฌุฒ ุฅุฐุง ูุฌุฏุช
            if (agentChanges) {
                changeLog += `\n--------------------------------------\n`;
                changeLog += `[${timestamp}] ูุงู ${userName} ุจุชุญุฏูุซ ุจูุงูุงุช ุฌูุฉ ุงูุญุฌุฒ:\n`;
                changeLog += agentChanges;
            }

            // ----- ููุงุฑูุฉ ุจูุงูุงุช ุงูุดุฑูุฉ -----
            let companyChanges = '';

            // ููุงุฑูุฉ ุญุงูุฉ ุงูุณุฏุงุฏ
            if (oldData.company.status !== newData.company.status) {
                companyChanges += `โข ุชุบููุฑ ุญุงูุฉ ุงูุณุฏุงุฏ: ${oldData.company.statusLabel} โ๏ธ ${newData.company.statusLabel}\n`;
                hasChanges = true;
            }

            // ููุงุฑูุฉ ุงููุจูุบ ุงููุฏููุน
            if (Math.abs(oldData.company.amount - newData.company.amount) > 0.01) {
                const diff = newData.company.amount - oldData.company.amount;
                const diffSymbol = diff > 0 ? 'โฒ' : 'โผ';
                const totalDue = parseFloat(document.getElementById('companyAmountDue').value.replace(/,/g, '')) || 0;
                const newPercentage = totalDue > 0 ? Math.round((newData.company.amount / totalDue) * 100) : 0;

                companyChanges +=
                    `โข ุชุบููุฑ ุงููุจูุบ ุงููุฏููุน: ${oldData.company.amountFormatted} ${currency} โ๏ธ ${newData.company.amountFormatted} ${currency}\n`;
                companyChanges +=
                    `  ${diffSymbol} ${diff > 0 ? 'ุฒูุงุฏุฉ' : 'ููุต'} ุจููุฏุงุฑ ${Math.abs(diff).toFixed(2)} ${currency}\n`;
                companyChanges += `โข ุงููุณุจุฉ ุงููุฆููุฉ ุงูุฌุฏูุฏุฉ ููุณุฏุงุฏ: ${newPercentage}%\n`;
                hasChanges = true;
            }

            // ุฅุถุงูุฉ ุณุฌู ุชุบููุฑุงุช ุงูุดุฑูุฉ ุฅุฐุง ูุฌุฏุช
            if (companyChanges) {
                changeLog += `\n--------------------------------------\n`;
                changeLog += `[${timestamp}] ูุงู ${userName} ุจุชุญุฏูุซ ุจูุงูุงุช ุงูุดุฑูุฉ:\n`;
                changeLog += companyChanges;
            }

            // ----- ููุงุฑูุฉ ุฅุนุฏุงุฏุงุช ุงููุชุงุจุนุฉ -----
            let settingsChanges = '';

            // ููุงุฑูุฉ ูุณุชูู ุงูุฃููููุฉ
            if (oldData.settings.priority !== newData.settings.priority) {
                settingsChanges +=
                    `โข ุชุบููุฑ ูุณุชูู ุงูุฃููููุฉ: ${oldData.settings.priorityLabel} โ๏ธ ${newData.settings.priorityLabel}\n`;
                hasChanges = true;
            }

            // ููุงุฑูุฉ ุชุงุฑูุฎ ุงูุงุณุชุญูุงู
            if (oldData.settings.payment_deadline !== newData.settings.payment_deadline) {
                const oldDate = oldData.settings.payment_deadline || 'ุบูุฑ ูุญุฏุฏ';
                const newDate = newData.settings.payment_deadline || 'ุบูุฑ ูุญุฏุฏ';
                settingsChanges += `โข ุชุบููุฑ ุชุงุฑูุฎ ุงูุงุณุชุญูุงู: ${oldDate} โ๏ธ ${newDate}\n`;
                hasChanges = true;
            }

            // ููุงุฑูุฉ ุชุงุฑูุฎ ุงููุชุงุจุนุฉ
            if (oldData.settings.follow_up_date !== newData.settings.follow_up_date) {
                const oldDate = oldData.settings.follow_up_date || 'ุบูุฑ ูุญุฏุฏ';
                const newDate = newData.settings.follow_up_date || 'ุบูุฑ ูุญุฏุฏ';
                settingsChanges += `โข ุชุบููุฑ ุชุงุฑูุฎ ุงููุชุงุจุนุฉ: ${oldDate} โ๏ธ ${newDate}\n`;
                hasChanges = true;
            }

            // ุฅุถุงูุฉ ุณุฌู ุชุบููุฑุงุช ุงูุฅุนุฏุงุฏุงุช ุฅุฐุง ูุฌุฏุช
            if (settingsChanges) {
                changeLog += `\n--------------------------------------\n`;
                changeLog += `[${timestamp}] ูุงู ${userName} ุจุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงููุชุงุจุนุฉ:\n`;
                changeLog += settingsChanges;
            }

            console.log('๐ ุณุฌู ุงูุชุบููุฑุงุช:', changeLog);

            // ุฅุถุงูุฉ ุณุฌู ุงูุชุบููุฑุงุช ุฅูู ุงูููุงุญุธุงุช ููุท ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุช
            if (hasChanges && changeLog) {
                // ุฅุถุงูุฉ ุงูุณุฌู ูููุงุญุธุงุช ุฌูุฉ ุงูุญุฌุฒ
                const agentNotesField = document.getElementById('agentPaymentNotes');
                if (agentNotesField) {
                    // ุงุณุชุฎุฏุงู ูุนุฑู ูุฑูุฏ ูุจูู ุนูู ุงูุทุงุจุน ุงูุฒููู
                    const uniqueId = Date.now().toString();

                    // ุฅุถุงูุฉ ุงูุณุฌู ููููุงุญุธุงุช ุงูุญุงููุฉ
                    agentNotesField.value += changeLog;

                    // ุชุญุฏูุซ ูููุฉ ุงูุญูู ูู formData - ูุฐุง ูู ุงูููุชุงุญ!
                    formData.set('agent_payment_notes', agentNotesField.value);

                    console.log('โ ุชู ุฅุถุงูุฉ ุณุฌู ุงูุชุบููุฑุงุช ุฅูู ููุงุญุธุงุช ุฌูุฉ ุงูุญุฌุฒ');
                }

                // ุฅุถุงูุฉ ุงูุณุฌู ูููุงุญุธุงุช ุงูุดุฑูุฉ
                const companyNotesField = document.getElementById('companyPaymentNotes');
                if (companyNotesField) {
                    // ุฅุถุงูุฉ ุงูุณุฌู ููููุงุญุธุงุช ุงูุญุงููุฉ
                    companyNotesField.value += changeLog;

                    // ุชุญุฏูุซ ูููุฉ ุงูุญูู ูู formData - ูุฐุง ูู ุงูููุชุงุญ!
                    formData.set('company_payment_notes', companyNotesField.value);

                    console.log('โ ุชู ุฅุถุงูุฉ ุณุฌู ุงูุชุบููุฑุงุช ุฅูู ููุงุญุธุงุช ุงูุดุฑูุฉ');
                }
            } else {
                console.log('โน๏ธ ูู ูุชู ุงูุชุดุงู ุฃู ุชุบููุฑุงุช ุชุณุชุญู ุงูุชุณุฌูู');
            }

            // ุชุฃูุฏ ูู ุชุถููู ุงูููู ุงูุตูุฑูุฉ
            if (!formData.get('agent_payment_amount')) {
                formData.set('agent_payment_amount', '0');
            }

            if (!formData.get('company_payment_amount')) {
                formData.set('company_payment_amount', '0');
            }

            // ุฅุถุงูุฉ ูุนุฑู ุงูุญุฌุฒ
            formData.append('booking_id', currentBookingId);

            // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู ูุชุนุทูู ุฒุฑ ุงูุญูุธ
            const saveButton = document.getElementById('saveFinancialTracking');
            const originalButtonText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ุฌุงุฑู ุงูุญูุธ...';

            console.log('๐ ุฅุฑุณุงู ุงูุจูุงูุงุช ููุญูุธุ ููุงุญุธุงุช ุฌูุฉ ุงูุญุฌุฒ:', formData.get('agent_payment_notes'));
            console.log('๐ ุฅุฑุณุงู ุงูุจูุงูุงุช ููุญูุธุ ููุงุญุธุงุช ุงูุดุฑูุฉ:', formData.get('company_payment_notes'));

            // ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู ุงูุฎุงุฏู
            fetch(`/bookings/${currentBookingId}/financial-tracking`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    body: formData
                })
                .then(async response => {
                    let data;
                    try {
                        data = await response.json();
                    } catch (error) {
                        console.error('โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูุงุณุชุฌุงุจุฉ:', error);
                        if (!response.ok) {
                            throw new Error(`ุฎุทุฃ ูู ุงูุงุณุชุฌุงุจุฉ: ${response.status}`);
                        }
                        throw new Error('ุชุนุฐุฑ ูุฑุงุกุฉ ุงุณุชุฌุงุจุฉ ุงูุฎุงุฏู');
                    }

                    if (!response.ok) {
                        throw new Error(data.error || data.message ||
                            `ุฎุทุฃ ${response.status}: ${response.statusText}`);
                    }

                    return data;
                })
                .then(data => {
                    console.log('โ ุชู ุญูุธ ุงููุชุงุจุนุฉ ุงููุงููุฉ ุจูุฌุงุญ:', data);

                    if (data.success) {
                        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
                        showSuccessMessage(data.message || 'ุชู ุญูุธ ุงููุชุงุจุนุฉ ุงููุงููุฉ ุจูุฌุงุญ');

                        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุชุฃุฎูุฑ ูุตูุฑ
                        setTimeout(() => {
                            loadFinancialTracking(currentBookingId);
                        }, 1000);
                    } else {
                        throw new Error(data.error || 'ูุดู ูู ุญูุธ ุงูุจูุงูุงุช');
                    }
                })
                .catch(error => {
                    console.error('โ ุฎุทุฃ ูู ุญูุธ ุงููุชุงุจุนุฉ ุงููุงููุฉ:', error);
                    showFinancialTrackingError(error.message || 'ุญุฏุซ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช');
                })
                .finally(() => {
                    // ุฅุนุงุฏุฉ ุชูุนูู ุฒุฑ ุงูุญูุธ ูุฅุฎูุงุก ูุคุดุฑ ุงูุชุญููู
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalButtonText;
                });
        }



        /**
         * ุงูุญุตูู ุนูู ุชุณููุฉ ุญุงูุฉ ุงูุณุฏุงุฏ
         * @param {string} status ุฑูุฒ ุงูุญุงูุฉ
         * @returns {string} ุชุณููุฉ ุงูุญุงูุฉ ุจุงูุนุฑุจูุฉ
         */
        function getStatusLabel(status) {
            switch (status) {
                case 'not_paid':
                    return 'ูู ูุชู ุงูุณุฏุงุฏ';
                case 'partially_paid':
                    return 'ุณุฏุงุฏ ุฌุฒุฆู';
                case 'fully_paid':
                    return 'ุชู ุงูุณุฏุงุฏ ุจุงููุงูู';
                default:
                    return status || 'ุบูุฑ ูุญุฏุฏ';
            }
        }

        /**
         * ุงูุญุตูู ุนูู ุชุณููุฉ ูุณุชูู ุงูุฃููููุฉ
         * @param {string} priority ุฑูุฒ ุงูุฃููููุฉ
         * @returns {string} ุชุณููุฉ ุงูุฃููููุฉ ุจุงูุนุฑุจูุฉ
         */
        function getPriorityLabel(priority) {
            switch (priority) {
                case 'low':
                    return 'ููุฎูุถุฉ';
                case 'medium':
                    return 'ูุชูุณุทุฉ';
                case 'high':
                    return 'ุนุงููุฉ';
                default:
                    return priority || 'ุบูุฑ ูุญุฏุฏุฉ';
            }
        }

        // ===== ุฏูุงู ูุณุงุนุฏุฉ ูููุงุฌูุฉ =====
        /**
         * ุชุณุฌูู ุงูุชุบููุฑุงุช ูู ุงูููุงุญุธุงุช
         * @param {Object} responseData ุงูุจูุงูุงุช ุงููุณุชููุฉ ูู ุงูุฎุงุฏู
         * @param {Object} oldData ุงูุจูุงูุงุช ุงููุฏููุฉ ูุจู ุงูุชุนุฏูู
         */


        /**
         * ุฅูุดุงุก ูุฅุถุงูุฉ ุณุฌู ุงูุชุบููุฑุงุช
         * @param {string} type ุงูููุน (agent ุฃู company)
         * @param {Object} changes ุงูุชุบููุฑุงุช
         * @param {string} currency ุงูุนููุฉ
         * @param {string} userName ุงุณู ุงููุณุชุฎุฏู
         * @param {string} timestamp ุงูููุช ูุงูุชุงุฑูุฎ
         * @param {Object} booking ุจูุงูุงุช ุงูุญุฌุฒ
         */
        // function createAndAppendChangeLog(type, changes, currency, userName, timestamp, booking) {
        //     if (!changes.statusChanged && !changes.amountChanged) return;

        //     const notesField = document.getElementById(`${type}PaymentNotes`);
        //     if (!notesField) return;

        //     const entityName = type === 'agent' ? 'ุฌูุฉ ุงูุญุฌุฒ' : 'ุงูุดุฑูุฉ';
        //     let log = `\n--------------------------------------\n`;
        //     log += `[${timestamp}] ูุงู ${userName} ุจุชุญุฏูุซ ุจูุงูุงุช ${entityName}:`;

        //     // ุชุบููุฑ ุญุงูุฉ ุงูุณุฏุงุฏ
        //     if (changes.statusChanged) {
        //         const oldStatusLabel = getStatusLabelText(changes.oldStatus);
        //         const newStatusLabel = getStatusLabelText(changes.newStatus);
        //         log += `\nโข ุชุบููุฑ ุงูุญุงูุฉ: ${oldStatusLabel} โ๏ธ ${newStatusLabel}`;
        //     }

        //     // ุชุบููุฑ ุงููุจูุบ ุงููุฏููุน
        //     if (changes.amountChanged) {
        //         const oldFormatted = formatCurrencyValue(changes.oldAmount, currency);
        //         const newFormatted = formatCurrencyValue(changes.newAmount, currency);

        //         // ุญุณุงุจ ุงููุฑู ุจูู ุงููุจูุบูู
        //         const diff = changes.newAmount - changes.oldAmount;
        //         const diffFormatted = formatCurrencyValue(Math.abs(diff), currency);
        //         const diffSymbol = diff > 0 ? 'โฒ' : 'โผ';

        //         log += `\nโข ุชุบููุฑ ุงููุจูุบ: ${oldFormatted} โ๏ธ ${newFormatted}`;
        //         log += `\n  ${diffSymbol} ${diff > 0 ? 'ุฒูุงุฏุฉ' : 'ููุต'} ุจููุฏุงุฑ ${diffFormatted}`;

        //         // ุญุณุงุจ ุงููุณุจุฉ ุงููุฆููุฉ ููุฏูุน
        //         const totalAmount = type === 'agent' ?
        //             (booking.amount_due_to_hotel || 0) :
        //             (booking.amount_due_from_company || 0);

        //         if (totalAmount > 0) {
        //             const percentage = Math.round((changes.newAmount / totalAmount) * 100);
        //             log += `\nโข ุงููุณุจุฉ ุงููุฆููุฉ ููุณุฏุงุฏ: ${percentage}%`;
        //         }
        //     }

        //     // ุฅุถุงูุฉ ุงูุณุฌู ููููุงุญุธุงุช
        //     if (notesField.value.includes(log)) {
        //         console.log(`ุชู ุชุฌุงูู ุณุฌู ููุฑุฑ ููู ${entityName}`);
        //         return;
        //     }

        //     notesField.value += log;
        // }

        /**
         * ุงูุญุตูู ุนูู ูุต ุญุงูุฉ ุงูุณุฏุงุฏ ุจุงูุนุฑุจูุฉ
         * @param {string} status ุญุงูุฉ ุงูุณุฏุงุฏ
         * @returns {string} ุงููุต ุงูุนุฑุจู ููุญุงูุฉ
         */
        function getStatusLabelText(status) {
            switch (status) {
                case 'not_paid':
                    return 'ูู ูุชู ุงูุณุฏุงุฏ';
                case 'partially_paid':
                    return 'ุณุฏุงุฏ ุฌุฒุฆู';
                case 'fully_paid':
                    return 'ุชู ุงูุณุฏุงุฏ ุจุงููุงูู';
                default:
                    return status || 'ุบูุฑ ูุญุฏุฏ';
            }
        }

        /**
         * ุชูุณูู ุงููููุฉ ุงูููุฏูุฉ
         * @param {number} amount ุงููุจูุบ
         * @param {string} currency ุงูุนููุฉ
         * @returns {string} ุงููุจูุบ ููุณูุงู ูุน ุงูุนููุฉ
         */
        function formatCurrencyValue(amount, currency) {
            return parseFloat(amount || 0).toLocaleString('ar-SA', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' ' + currency;
        }

        /**
         * ุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู
         */
        function showFinancialTrackingLoader() {
            document.getElementById('financialTrackingLoader').style.display = 'block';
            document.getElementById('financialTrackingContent').style.display = 'none';
            document.getElementById('financialTrackingError').style.display = 'none';
        }

        /**
         * ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู
         */
        function hideFinancialTrackingLoader() {
            document.getElementById('financialTrackingLoader').style.display = 'none';
        }

        /**
         * ุฅุธูุงุฑ ูุญุชูู ุงููุชุงุจุนุฉ ุงููุงููุฉ
         */
        function showFinancialTrackingContent() {
            document.getElementById('financialTrackingContent').style.display = 'block';
            document.getElementById('financialTrackingError').style.display = 'none';
        }

        /**
         * ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ
         * 
         * @param {string} message ุฑุณุงูุฉ ุงูุฎุทุฃ
         */
        function showFinancialTrackingError(message) {
            document.getElementById('financialTrackingErrorMessage').textContent = message;
            document.getElementById('financialTrackingError').style.display = 'block';
            document.getElementById('financialTrackingContent').style.display = 'none';
        }

        /**
         * ุฅุฎูุงุก ุฑุณุงูุฉ ุงูุฎุทุฃ
         */
        function hideFinancialTrackingError() {
            document.getElementById('financialTrackingError').style.display = 'none';
        }

        /**
         * ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
         * 
         * @param {string} message ุฑุณุงูุฉ ุงููุฌุงุญ
         */
        function showSuccessMessage(message) {
            // ูููู ุงุณุชุฎุฏุงู Bootstrap Toast ุฃู Alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

            document.body.appendChild(alertDiv);

            // ุฅุฒุงูุฉ ุงูุฑุณุงูุฉ ุจุนุฏ 5 ุซูุงูู
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // ===== ุฏูุงู ูุณุงุนุฏุฉ ููุชูุณูู =====

        /**
         * ุชูุณูู ุงูุฃุฑูุงู
         * 
         * @param {number} number ุงูุฑูู ุงููุฑุงุฏ ุชูุณููู
         * @returns {string} ุงูุฑูู ููุณู
         */
        function formatNumber(number) {
            return parseFloat(number || 0).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        /**
         * ุชูุณูู ุงูุชุงุฑูุฎ
         * 
         * @param {string} dateString ุชุงุฑูุฎ ูู ุตูุบุฉ ูุตูุฉ
         * @returns {string} ุงูุชุงุฑูุฎ ููุณู
         */
        function formatDate(dateString) {
            if (!dateString) return '-';

            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        /**
         * ุชุญููู ุงูุชุงุฑูุฎ ุงููููุงุฏู ุฅูู ูุฌุฑู
         * 
         * @param {string} dateString ุชุงุฑูุฎ ูู ุตูุบุฉ ูุตูุฉ
         * @returns {string} ุงูุชุงุฑูุฎ ุจุงููุฌุฑู
         */
        function formatHijriDate(date) {
            if (!date) return '-';

            if (typeof date === 'string') {
                date = new Date(date);
            }

            // ุนุฑุถ ุงูุดูุฑ ุงููุฌุฑู ุจุงุณูู ุจุฏูุงู ูู ุงูุฑูู
            const hijriMonths = [
                'ูุญุฑู', 'ุตูุฑ', 'ุฑุจูุน ุงูุฃูู', 'ุฑุจูุน ุงูุซุงูู',
                'ุฌูุงุฏู ุงูุฃููู', 'ุฌูุงุฏู ุงูุขุฎุฑุฉ', 'ุฑุฌุจ', 'ุดุนุจุงู',
                'ุฑูุถุงู', 'ุดูุงู', 'ุฐู ุงููุนุฏุฉ', 'ุฐู ุงูุญุฌุฉ'
            ];

            // ุงูุญุตูู ุนูู ุงูุชุงุฑูุฎ ุงููุฌุฑู
            const hijri = date.toLocaleDateString('ar-SA', {
                day: 'numeric',
                month: 'long',
                calendar: 'islamic'
            }).split('/');

            // ุชุญููู ุงูุฃุฑูุงู ูู ุงูุนุฑุจูุฉ ููุฅูุฌููุฒูุฉ
            const day = parseInt(hijri[0].replace(/[\u0660-\u0669]/g, d => d.charCodeAt(0) - 1632));
            const month = parseInt(hijri[1].replace(/[\u0660-\u0669]/g, d => d.charCodeAt(0) - 1632));

            // ุชุญููู ุงูุฃุฑูุงู ููุฃุฑูุงู ุงูุนุฑุจูุฉ ูุฑุฉ ุฃุฎุฑู
            const arabicDay = day.toLocaleString('ar-SA');

            // ุฅุฑุฌุงุน ุงูุชุงุฑูุฎ ุจุงูุตูุบุฉ ุงููุทููุจุฉ
            return `${arabicDay} ${hijriMonths[month-1]}`;
        }


        /**
         * ุชูุณูู ุงูุชุงุฑูุฎ ูุงูููุช
         * 
         * @param {string} dateTimeString ุชุงุฑูุฎ ูููุช ูู ุตูุบุฉ ูุตูุฉ
         * @returns {string} ุงูุชุงุฑูุฎ ูุงูููุช ููุณู
         */
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';

            const date = new Date(dateTimeString);
            return date.toLocaleString('ar-SA', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ===== ุฃุญุฏุงุซ DOM =====

        document.addEventListener('DOMContentLoaded', function() {
            console.log('๐ ุชู ุชุญููู JavaScript ูููุชุงุจุนุฉ ุงููุงููุฉ');

            // ===== ุฅุถุงูุฉ ุฃุญุฏุงุซ ููุชุญูู ูู ุญุงูุฉ ุงูุณุฏุงุฏ =====

            // ุฃุญุฏุงุซ ุชุบููุฑ ุญุงูุฉ ุงูุณุฏุงุฏ ูุฌูุฉ ุงูุญุฌุฒ
            document.querySelectorAll('input[name="agent_payment_status"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('๐ ุชุบููุฑ ุญุงูุฉ ุงูุณุฏุงุฏ ูุฌูุฉ ุงูุญุฌุฒ:', this.value);
                    updatePaymentAmountVisibility();
                });
            });

            // ุฃุญุฏุงุซ ุชุบููุฑ ุญุงูุฉ ุงูุณุฏุงุฏ ููุดุฑูุฉ
            document.querySelectorAll('input[name="company_payment_status"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('๐ ุชุบููุฑ ุญุงูุฉ ุงูุณุฏุงุฏ ููุดุฑูุฉ:', this.value);
                    updatePaymentAmountVisibility();
                });
            });

            // ุฃุญุฏุงุซ ุชุบููุฑ ุงููุจูุบ ุงููุฏููุน
            document.getElementById('agentPaymentAmount').addEventListener('input', function() {
                updateProgressBars();
            });

            document.getElementById('companyPaymentAmount').addEventListener('input', function() {
                updateProgressBars();
            });

            // ุญุฏุซ ุญูุธ ุงููุชุงุจุนุฉ ุงููุงููุฉ
            document.getElementById('saveFinancialTracking').addEventListener('click', function(e) {
                e.preventDefault();
                saveFinancialTracking();
            });

            // ููุน ุฅุบูุงู Modal ุนูุฏ ุงูููุฑ ุฎุงุฑุฌู ุฃุซูุงุก ุงูุชุญููู
            document.getElementById('financialTrackingModal').addEventListener('hide.bs.modal', function(e) {
                if (isLoadingFinancialData) {
                    e.preventDefault();
                    console.log('โณ ููุน ุฅุบูุงู Modal ุฃุซูุงุก ุงูุชุญููู');
                }
            });

            console.log('โ ุชู ุชุฌููุฒ ุฌููุน ุฃุญุฏุงุซ ุงููุชุงุจุนุฉ ุงููุงููุฉ');
        });
    </script>
    <script>
        /**
         * ===== ููุฒุงุช ุฏูุนุงุช ุงููุชุงุจุนุฉ ุงููุงููุฉ ุงููุชุนุฏุฏุฉ =====
         * 
         * ูุฐุง ุงูููุฏ ูุถูู:
         * 1. ุฃุฒุฑุงุฑ ูุฅุถุงูุฉ ุฏูุนุฉ ุฌุฒุฆูุฉ ุฌุฏูุฏุฉ ุฅูู ุงููุจูุบ ุงูุญุงูู
         * 2. ุณุฌู ุขูู ููุชุบููุฑุงุช ูู ุญูู ุงูููุงุญุธุงุช
         */
        document.addEventListener('DOMContentLoaded', function() {
            // ===== ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุงูุฏูุนุฉ ุงูุฅุถุงููุฉ =====

            // ุฅุถุงูุฉ ุฒุฑ ููุฏูุนุฉ ุงูุฅุถุงููุฉ ูุฌูุฉ ุงูุญุฌุฒ
            const agentPartialLabel = document.querySelector('label[for="agentPartiallyPaid"]');
            if (agentPartialLabel) {
                // ุฅูุดุงุก ุฒุฑ ุตุบูุฑ ุจุฌุงูุจ ุฎูุงุฑ "ุชู ุงูุชุญุตูู ุฌุฒุฆูุงู"
                const addAgentPaymentBtn = document.createElement('button');
                addAgentPaymentBtn.type = 'button';
                addAgentPaymentBtn.className = 'btn btn-sm btn-outline-warning ms-2';
                addAgentPaymentBtn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> ุฅุถุงูุฉ ุฏูุนุฉ';
                addAgentPaymentBtn.title = 'ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ ุฅูู ุงููุจูุบ ุงููุฏููุน ุงูุญุงูู';
                addAgentPaymentBtn.id = 'addAgentPaymentBtn';

                // ุฅุถุงูุฉ ุงูุฒุฑ ุจุนุฏ ุงููุต
                agentPartialLabel.appendChild(addAgentPaymentBtn);

                // ุฅุถุงูุฉ ุญุฏุซ ุงูููุฑ ููุฒุฑ
                addAgentPaymentBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // ููุน ุงูุณููู ุงูุงูุชุฑุงุถู
                    showAdditionalPaymentModal('agent');
                });
            }

            // ุฅุถุงูุฉ ุฒุฑ ููุฏูุนุฉ ุงูุฅุถุงููุฉ ููุดุฑูุฉ
            const companyPartialLabel = document.querySelector('label[for="companyPartiallyPaid"]');
            if (companyPartialLabel) {
                // ุฅูุดุงุก ุฒุฑ ุตุบูุฑ ุจุฌุงูุจ ุฎูุงุฑ "ุชู ุงูุชุญุตูู ุฌุฒุฆูุงู"
                const addCompanyPaymentBtn = document.createElement('button');
                addCompanyPaymentBtn.type = 'button';
                addCompanyPaymentBtn.className = 'btn btn-sm btn-outline-warning ms-2';
                addCompanyPaymentBtn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> ุฅุถุงูุฉ ุฏูุนุฉ';
                addCompanyPaymentBtn.title = 'ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ ุฅูู ุงููุจูุบ ุงููุฏููุน ุงูุญุงูู';
                addCompanyPaymentBtn.id = 'addCompanyPaymentBtn';

                // ุฅุถุงูุฉ ุงูุฒุฑ ุจุนุฏ ุงููุต
                companyPartialLabel.appendChild(addCompanyPaymentBtn);

                // ุฅุถุงูุฉ ุญุฏุซ ุงูููุฑ ููุฒุฑ
                addCompanyPaymentBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // ููุน ุงูุณููู ุงูุงูุชุฑุงุถู
                    showAdditionalPaymentModal('company');
                });
            }

            /**
             * ุนุฑุถ ูุงูุฐุฉ ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ
             * 
             * @param {string} type ููุน ุงูุฌูุฉ ('agent' ูููููู ุฃู 'company' ููุดุฑูุฉ)
             */
            function showAdditionalPaymentModal(type) {
                // ุงูุชุญูู ูู ูุฌูุฏ ููุฏุงู ุณุงุจู ูุฅุฒุงูุชู
                const existingModal = document.getElementById('additionalPaymentModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // ุงููุชุบูุฑุงุช ุงููุณุชุฎุฏูุฉ ุญุณุจ ููุน ุงูุฌูุฉ
                const entityName = type === 'agent' ? 'ุฌูุฉ ุงูุญุฌุฒ' : 'ุงูุดุฑูุฉ';
                const entityColor = type === 'agent' ? 'primary' : 'success';
                const currentAmount = parseFloat(document.getElementById(`${type}PaymentAmount`).value) || 0;
                const totalDue = parseFloat(document.getElementById(`${type}AmountDue`).value.replace(/,/g, '')) ||
                    0;
                const remainingAmount = totalDue - currentAmount;
                const currency = document.getElementById(`${type}Currency`).textContent;

                // ุฅูุดุงุก ุงูููุฏุงู
                const modalHTML = `
        <div class="modal fade" id="additionalPaymentModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-${entityColor} text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-plus-circle me-2"></i>
                            ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ ูู ${entityName}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ุฅุบูุงู"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ุชูุณูู ุฌุฏูุฏ ููุนูููุงุช ุงูุฏูุนุฉ ุงูุญุงููุฉ -->
                        <div class="card border-info mb-4">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    ูุนูููุงุช ุงูุฏูุนุฉ ุงูุญุงููุฉ
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="fw-bold text-primary mb-1">ุงููุจูุบ ุงููุณุชุญู ุงูููู:</div>
                                        <h5 class="mb-3">${formatNumber(totalDue)} ${currency}</h5>
                                    </div>
                                    <div class="col-6">
                                        <div class="fw-bold text-success mb-1">ุงููุจูุบ ุงููุฏููุน ุญุงููุงู:</div>
                                        <h5 class="mb-3">${formatNumber(currentAmount)} ${currency}</h5>
                                    </div>
                                    <div class="col-12">
                                        <div class="fw-bold text-danger mb-1">ุงููุจูุบ ุงููุชุจูู:</div>
                                        <h5>${formatNumber(remainingAmount)} ${currency}</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="additionalAmount" class="form-label fw-bold">
                                <i class="fas fa-money-bill-wave text-${entityColor} me-1"></i>
                                ูุจูุบ ุงูุฏูุนุฉ ุงูุฅุถุงููุฉ:
                            </label>
                            <div class="input-group input-group-lg">
                                <input type="number" step="0.01" min="0.01" max="${remainingAmount}" 
                                       class="form-control form-control-lg text-center fw-bold" 
                                       id="additionalAmount" placeholder="ุฃุฏุฎู ุงููุจูุบ" required>
                                <span class="input-group-text bg-${entityColor} text-white">${currency}</span>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                                ุงููุจูุบ ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ ูุฃูู ูู ุฃู ูุณุงูู ${formatNumber(remainingAmount)} ${currency}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="additionalNoteText" class="form-label fw-bold">
                                <i class="fas fa-sticky-note text-${entityColor} me-1"></i>
                                ููุงุญุธุฉ ุฎุงุตุฉ ุจุงูุฏูุนุฉ ุงูุฅุถุงููุฉ:
                            </label>
                            <textarea class="form-control" id="additionalNoteText" rows="3"
                                placeholder="ุฃุถู ุฃู ููุงุญุธุงุช ุฎุงุตุฉ ุจูุฐู ุงูุฏูุนุฉ ุงูุฅุถุงููุฉ..."></textarea>
                        </div>
                        
                        <!-- ุชูุณูู ุฌุฏูุฏ ููููุงุญุธุฉ ูู ุงูุฃุณูู -->
                        <div class="alert alert-warning d-flex align-items-center" role="alert">
                            <i class="fas fa-lightbulb fs-5 me-3"></i>
                            <div>
                                ุณูุชู ุฅุถุงูุฉ ุงููุจูุบ ุงูุฌุฏูุฏ ุฅูู ุงููุจูุบ ุงููุฏููุน ุงูุญุงููุ ูุณูุชู ุชุญุฏูุซ ุงูููุงุญุธุงุช ุชููุงุฆูุงู.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i> ุฅูุบุงุก
                        </button>
                        <button type="button" class="btn btn-${entityColor}" id="confirmAdditionalPayment">
                            <i class="fas fa-check me-1"></i> ุฅุถุงูุฉ ุงูุฏูุนุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;


                // ุฅุถุงูุฉ ุงูููุฏุงู ุฅูู ุงูุตูุญุฉ
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // ุชููุฆุฉ ุงูููุฏุงู ูุนุฑุถู
                const modalElement = document.getElementById('additionalPaymentModal');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // ุฅุถุงูุฉ ุญุฏุซ ููุฒุฑ ุงูุชุฃููุฏ
                document.getElementById('confirmAdditionalPayment').addEventListener('click', function() {
                    addAdditionalPayment(type, modal);
                });

                // ุฅุถุงูุฉ ุญุฏุซ ูุฅุฏุฎุงู ุงููุจูุบ ููุชุญูู ูู ุงููููุฉ
                document.getElementById('additionalAmount').addEventListener('input', function() {
                    validateAdditionalAmount(this, remainingAmount);
                });
            }

            /**
             * ุงูุชุญูู ูู ุตุญุฉ ุงููุจูุบ ุงูุฅุถุงูู
             * 
             * @param {HTMLInputElement} input ุญูู ุฅุฏุฎุงู ุงููุจูุบ
             * @param {number} maxAmount ุงูุญุฏ ุงูุฃูุตู ุงููุณููุญ ุจู
             */
            function validateAdditionalAmount(input, maxAmount) {
                const value = parseFloat(input.value) || 0;

                if (value <= 0) {
                    input.setCustomValidity('ุงููุจูุบ ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ');
                    input.classList.add('is-invalid');
                } else if (value > maxAmount) {
                    input.setCustomValidity(`ุงููุจูุบ ูุฌุจ ุฃู ูููู ุฃูู ูู ุฃู ูุณุงูู ${maxAmount}`);
                    input.classList.add('is-invalid');
                } else {
                    input.setCustomValidity('');
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                }
            }

            /**
             * ุฅุถุงูุฉ ุงูุฏูุนุฉ ุงูุฅุถุงููุฉ ุฅูู ุงููุจูุบ ุงูุญุงูู
             * 
             * @param {string} type ููุน ุงูุฌูุฉ ('agent' ูููููู ุฃู 'company' ููุดุฑูุฉ)
             * @param {bootstrap.Modal} modal ูุงุฆู ุงูููุฏุงู
             */
            function addAdditionalPayment(type, modal) {
                // ุฌูุจ ุงููุชุบูุฑุงุช ูุงูููู
                const additionalAmountInput = document.getElementById('additionalAmount');
                const additionalNoteInput = document.getElementById('additionalNoteText');

                // ุงูุชุญูู ูู ุตุญุฉ ุงููุจูุบ
                const additionalAmount = parseFloat(additionalAmountInput.value) || 0;
                const currentAmount = parseFloat(document.getElementById(`${type}PaymentAmount`).value) || 0;
                const totalDue = parseFloat(document.getElementById(`${type}AmountDue`).value.replace(/,/g, '')) ||
                    0;
                const remainingAmount = totalDue - currentAmount;

                if (additionalAmount <= 0 || additionalAmount > remainingAmount) {
                    additionalAmountInput.focus();
                    return;
                }

                // ุงูููุงุญุธุงุช ุงูุฅุถุงููุฉ
                const additionalNote = additionalNoteInput.value.trim();

                // ุชุญุฏูุซ ุงููุจูุบ ุงููุฏููุน (ุฅุถุงูุฉ ุงููุจูุบ ุงูุฅุถุงูู ูููุจูุบ ุงูุญุงูู)
                const newTotalPaid = currentAmount + additionalAmount;
                document.getElementById(`${type}PaymentAmount`).value = newTotalPaid.toFixed(2);

                // ุชุบููุฑ ุญุงูุฉ ุงูุณุฏุงุฏ ุฅูู "ุฌุฒุฆู" ุฅุฐุง ูุฒู ุงูุฃูุฑ
                document.getElementById(`${type}PartiallyPaid`).checked = true;

                // ุชุญุฏูุซ ููุงุญุธุงุช ุงูุฏูุน ุจุฅุถุงูุฉ ุณุฌู ููุฏูุนุฉ ุงูุฌุฏูุฏุฉ
                const notesField = document.getElementById(`${type}PaymentNotes`);
                const currentNotes = notesField.value;
                const entityName = type === 'agent' ? 'ุฌูุฉ ุงูุญุฌุฒ' : 'ุงูุดุฑูุฉ';
                const currency = document.getElementById(`${type}Currency`).textContent;
                const userName = "{{ Auth::user()->name }}"; // ุงุณู ุงููุณุชุฎุฏู ุงูุญุงูู

                // ุฅูุดุงุก ุณุฌู ุงูุฏูุนุฉ ุงูุฌุฏูุฏ
                const now = new Date();
                const timestamp = now.toLocaleDateString('ar-SA') + ' ' + now.toLocaleTimeString('ar-SA');

                let paymentLog = `\n--------------------------------------\n`;
                paymentLog += `[${timestamp}] ูุงู ${userName} ุจุชุณุฌูู ุฏูุนุฉ ุฅุถุงููุฉ`;
                paymentLog += `\nุงููุจูุบ: ${additionalAmount.toFixed(2)} ${currency}`;
                paymentLog += `\nุฅุฌูุงูู ุงููุฏููุน: ${newTotalPaid.toFixed(2)} ูู ${totalDue.toFixed(2)} ${currency}`;
                paymentLog += `\nุงููุณุจุฉ: ${Math.round((newTotalPaid / totalDue) * 100)}%`;

                if (additionalNote) {
                    paymentLog += `\nููุงุญุธุงุช: ${additionalNote}`;
                }

                // ุฅุถุงูุฉ ุงูุณุฌู ููููุงุญุธุงุช ุงูุญุงููุฉ
                notesField.value = currentNotes + paymentLog;

                // ุชุญุฏูุซ ุฃุดุฑุทุฉ ุงูุชูุฏู ูุงููุณุจ ุงููุฆููุฉ
                updateProgressBars();

                // ุฅุบูุงู ุงูููุฏุงู
                modal.hide();

                // ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ
                showSuccessMessage(
                    `ุชู ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ ุจูููุฉ ${additionalAmount.toFixed(2)} ${currency} ุฅูู ${entityName}`);
            }

            // ===== ุงูุชุนุฏูู ุนูู ูุธููุฉ ุญูุธ ุงููุชุงุจุนุฉ ุงููุงููุฉ =====

            // // ูุญูุธ ุงูุฏุงูุฉ ุงูุฃุตููุฉ
            // const originalSaveFinancialTracking = saveFinancialTracking;

            // // ุงุณุชุจุฏุงู ุงูุฏุงูุฉ ุจูุณุฎุฉ ูุนุฏููุฉ ุชุถูู ุงูุณุฌู
            // saveFinancialTracking = function() {
            //     // ุฌูุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุจู ุงูุญูุธ
            //     const oldData = collectCurrentFormData();

            //     // ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุงูุฃุตููุฉ ูุญูุธ ุงูุจูุงูุงุช
            //     const result = originalSaveFinancialTracking.apply(this, arguments);

            //     // ุงูุชูู ุงูุชูููุฐ ูุชู ุงูุญูุธ ุจูุฌุงุญ (ุณูุนุชูุฏ ุนูู ุฑุฏ ุงููุชุงุจุนุฉ ุงููุงุฌุญ ูุชุญุฏูุซ ุงูุณุฌูุงุช)
            //     return result;
            // };

            /**
             * ุฌูุน ุจูุงูุงุช ุงููููุฐุฌ ุงูุญุงููุฉ ูุจู ุงูุญูุธ
             * ูุงุณุชุฎุฏุงููุง ูู ููุงุฑูุฉ ุงูุชุบููุฑุงุช
             */
            function collectCurrentFormData() {
                return {
                    agent: {
                        status: document.querySelector('input[name="agent_payment_status"]:checked').value,
                        amount: parseFloat(document.getElementById('agentPaymentAmount').value) || 0,
                        notes: document.getElementById('agentPaymentNotes').value
                    },
                    company: {
                        status: document.querySelector('input[name="company_payment_status"]:checked').value,
                        amount: parseFloat(document.getElementById('companyPaymentAmount').value) || 0,
                        notes: document.getElementById('companyPaymentNotes').value
                    },
                    priority: document.getElementById('priorityLevel').value,
                    payment_deadline: document.getElementById('paymentDeadline').value,
                    follow_up_date: document.getElementById('followUpDate').value
                };
            }



            /**
             * ุงูุชุญูู ูู ูุฌูุฏ ุชุบููุฑุงุช ูู ุจูุงูุงุช ุฌูุฉ ุงูุญุฌุฒ
             */
            function hasAgentChanges(oldData, newData) {
                return oldData.agent.status !== newData.agent.status ||
                    oldData.agent.amount !== newData.agent.amount;
            }

            /**
             * ุงูุชุญูู ูู ูุฌูุฏ ุชุบููุฑุงุช ูู ุจูุงูุงุช ุงูุดุฑูุฉ
             */
            function hasCompanyChanges(oldData, newData) {
                return oldData.company.status !== newData.company.status ||
                    oldData.company.amount !== newData.company.amount;
            }



            /**
             * ุงูุญุตูู ุนูู ุชุณููุฉ ุงูุญุงูุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ
             */
            function getStatusLabel(statusValue) {
                switch (statusValue) {
                    case 'not_paid':
                        return 'ูู ูุชู ุงูุณุฏุงุฏ';
                    case 'partially_paid':
                        return 'ุณุฏุงุฏ ุฌุฒุฆู';
                    case 'fully_paid':
                        return 'ุชู ุงูุณุฏุงุฏ ุจุงููุงูู';
                    default:
                        return statusValue;
                }
            }

            // /**
            //  * ุชุนุฏูู ุฏุงูุฉ ุงุณุชุฌุงุจุฉ ุงูุฎุงุฏู ูุฅุถุงูุฉ ุงูุณุฌู
            //  */
            // const originalThenCallback = window.fetch;
            // window.fetch = function() {
            //     const fetchPromise = originalThenCallback.apply(this, arguments);

            //     // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ูุฐุง ุทูุจ ุญูุธ ุงููุชุงุจุนุฉ ุงููุงููุฉ
            //     const url = arguments[0];
            //     if (typeof url === 'string' && url.includes('financial-tracking') && arguments[1]?.method ===
            //         'POST') {
            //         // ุฌูุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุจู ุฅุฑุณุงู ุงูุทูุจ
            //         const oldData = collectCurrentFormData();

            //         // ุชุนุฏูู ุณููู ุงูู then ููุงุณุชุฌุงุจุฉ ุงููุงุฌุญุฉ
            //         return fetchPromise.then(response => {
            //             // ุงูุชุญูู ููุง ุฅุฐุง ูุงูุช ุงูุงุณุชุฌุงุจุฉ ูุงุฌุญุฉ
            //             if (response.ok) {
            //                 // ูุญุชุงุฌ ุฅูู ูุณุฎุฉ ูู ุงูุงุณุชุฌุงุจุฉ ูุฃู ุงุณุชููุงููุง ูุญุฏุซ ูุฑุฉ ูุงุญุฏุฉ ููุท
            //                 const clonedResponse = response.clone();

            //                 // ูุนุงูุฌุฉ ุงูุจูุงูุงุช ูุฅุถุงูุฉ ุงูุณุฌู ุจุนุฏ ุงูุญุตูู ุนูู ุงุณุชุฌุงุจุฉ ูุงุฌุญุฉ
            //                 clonedResponse.json().then(data => {
            //                     if (data.success) {
            //                         // ุฅุถุงูุฉ ุณุฌู ุจุนุฏ ุงูุชุญููู ุงููุงุฌุญ ููุจูุงูุงุช ุงููุญุฏุซุฉ
            //                         setTimeout(() => {
            //                             const newData = collectCurrentFormData();
            //                             addChangeLogToNotes(oldData, newData);
            //                         }, 1500); // ุชุฃุฎูุฑ ูููู ููุชุฃูุฏ ูู ุชุญุฏูุซ ุงูุจูุงูุงุช
            //                     }
            //                 }).catch(err => console.error('ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุงุณุชุฌุงุจุฉ:', err));
            //             }
            //             return response;
            //         });
            //     }

            //     // ุฅุฐุง ูู ููู ุทูุจ ูุชุงุจุนุฉ ูุงููุฉุ ูุนูุฏ ุงููุนุฏ ุงูุฃุตูู
            //     return fetchPromise;
            // };

            /**
             * ุชูุณูู ุงูุฃุฑูุงู ุจุทุฑููุฉ ุฌูููุฉ
             */
            function formatNumber(number) {
                return parseFloat(number || 0).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        });
    </script>
    <script>
        /**
         * ุงูุชุญูู ูู ูุฌูุฏ ุชุบููุฑุงุช ูู ุจูุงูุงุช ุฌูุฉ ุงูุญุฌุฒ
         * 
         * @param {Object} oldData ุงูุจูุงูุงุช ุงููุฏููุฉ
         * @param {Object} newData ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
         * @returns {boolean} ูู ููุงู ุชุบููุฑุงุชุ
         */
        function hasAgentChanges(oldData, newData) {
            return oldData.agent.status !== newData.agent_payment_status ||
                Math.abs(parseFloat(oldData.agent.amount || 0) - parseFloat(newData.agent_payment_amount || 0)) > 0.01;
        }

        /**
         * ุงูุชุญูู ูู ูุฌูุฏ ุชุบููุฑุงุช ูู ุจูุงูุงุช ุงูุดุฑูุฉ
         * 
         * @param {Object} oldData ุงูุจูุงูุงุช ุงููุฏููุฉ
         * @param {Object} newData ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
         * @returns {boolean} ูู ููุงู ุชุบููุฑุงุชุ
         */
        function hasCompanyChanges(oldData, newData) {
            return oldData.company.status !== newData.company_payment_status ||
                Math.abs(parseFloat(oldData.company.amount || 0) - parseFloat(newData.company_payment_amount || 0)) > 0.01;
        }





        /**
         * ุฅุถุงูุฉ ูุต ุฅูู ุญูู ุงูููุงุญุธุงุช
         * 
         * @param {string} type ุงูููุน (agent ุฃู company)
         * @param {string} log ุงููุต ุงููุฑุงุฏ ุฅุถุงูุชู
         */
        function appendToNotesField(type, log) {
            if (!log) return;

            const fieldId = type === 'agent' ? 'agentPaymentNotes' : 'companyPaymentNotes';
            const notesField = document.getElementById(fieldId);

            if (!notesField) {
                console.warn(`ุญูู ุงูููุงุญุธุงุช ${fieldId} ุบูุฑ ููุฌูุฏ`);
                return;
            }

            // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุณุฌู
            if (notesField.value.includes(log)) {
                console.log(`ุชู ุชุฌุงูู ุณุฌู ููุฑุฑ ูู ${type === 'agent' ? 'ุฌูุฉ ุงูุญุฌุฒ' : 'ุงูุดุฑูุฉ'}`);
                return;
            }

            notesField.value += log;
        }

        /**
         * ุชูุณูู ุงูุชุงุฑูุฎ ุฃู ุฅุฑุฌุงุน ูููุฉ ุงูุชุฑุงุถูุฉ
         * 
         * @param {string} dateString ุณูุณูุฉ ุงูุชุงุฑูุฎ
         * @returns {string} ุงูุชุงุฑูุฎ ุงูููุณู ุฃู "ุบูุฑ ูุญุฏุฏ"
         */
        function formatDateOrDefault(dateString) {
            if (!dateString) return 'ุบูุฑ ูุญุฏุฏ';

            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (error) {
                return dateString || 'ุบูุฑ ูุญุฏุฏ';
            }
        }

        /**
         * ุงูุญุตูู ุนูู ุชุณููุฉ ุงูุฃููููุฉ
         * 
         * @param {string} priority ุฑูุฒ ุงูุฃููููุฉ
         * @returns {string} ุชุณููุฉ ุงูุฃููููุฉ
         */
        function getPriorityLabel(priority) {
            switch (priority) {
                case 'low':
                    return 'ููุฎูุถุฉ';
                case 'medium':
                    return 'ูุชูุณุทุฉ';
                case 'high':
                    return 'ุนุงููุฉ';
                default:
                    return priority || 'ุบูุฑ ูุญุฏุฏุฉ';
            }
        }

        /**
         * ุงูุญุตูู ุนูู ุชุณููุฉ ุญุงูุฉ ุงูุณุฏุงุฏ
         * 
         * @param {string} status ุฑูุฒ ุงูุญุงูุฉ
         * @returns {string} ุชุณููุฉ ุงูุญุงูุฉ
         */
        function getStatusLabelText(status) {
            switch (status) {
                case 'not_paid':
                    return 'ูู ูุชู ุงูุณุฏุงุฏ';
                case 'partially_paid':
                    return 'ุณุฏุงุฏ ุฌุฒุฆู';
                case 'fully_paid':
                    return 'ุชู ุงูุณุฏุงุฏ ุจุงููุงูู';
                default:
                    return status || 'ุบูุฑ ูุญุฏุฏ';
            }
        }

        /**
         * ุชูุณูู ุงููููุฉ ุงูููุฏูุฉ ูุน ุงูุนููุฉ
         * 
         * @param {number} amount ุงููุจูุบ
         * @param {string} currency ุงูุนููุฉ
         * @returns {string} ุงููุจูุบ ููุณูุงู ูุน ุงูุนููุฉ
         */
        function formatCurrencyValue(amount, currency) {
            return parseFloat(amount || 0).toLocaleString('ar-SA', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' ' + currency;
        }
    </script>
    <script>
        // Converts Gregorian dates to Hijri
        function convertToHijri() {
            document.querySelectorAll('.hijri-date').forEach(element => {
                const gregorianDate = element.getAttribute('data-date');
                if (gregorianDate) {
                    try {
                        // Use Intl.DateTimeFormat with 'islamic' calendar - month as LONG text
                        const hijriDate = new Intl.DateTimeFormat('ar-SA-islamic', {
                            day: 'numeric',
                            month: 'long', // ุชู ุชุบููุฑูุง ูู 'numeric' ุฅูู 'long'
                            calendar: 'islamic'
                        }).format(new Date(gregorianDate));

                        element.textContent = hijriDate;
                    } catch (e) {
                        console.error("Error converting date:", e);
                        element.textContent = ""; // Clear if error
                    }
                }
            });
        }


        // Convert dates when page loads
        document.addEventListener("DOMContentLoaded", function() {
            convertToHijri();

            // Also convert when table is updated via AJAX
            document.addEventListener('ajaxTableUpdated', convertToHijri);
        });
    </script>
@endpush

@push('styles')
    <style>
        /* ===== ุชูุณููุงุช Modal ุงููุชุงุจุนุฉ ุงููุงููุฉ ===== */

        #financialTrackingModal .modal-dialog {
            max-width: 95%;
            margin: 1rem auto;
        }

        #financialTrackingModal .modal-content {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #financialTrackingModal .modal-header {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            border-bottom: none;
        }

        #financialTrackingModal .modal-footer {
            border-top: 1px solid #e9ecef;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        /* ุชูุณููุงุช ุงูุจุทุงูุงุช */
        #financialTrackingModal .card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }

        #financialTrackingModal .card:hover {
            transform: translateY(-2px);
        }

        #financialTrackingModal .card-header {
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            border-bottom: none;
            font-weight: 600;
        }

        /* ุชูุณููุงุช ุฃุดุฑุทุฉ ุงูุชูุฏู */
        #financialTrackingModal .progress {
            height: 20px;
            border-radius: 10px;
            background-color: #e9ecef;
            overflow: hidden;
        }

        #financialTrackingModal .progress-bar {
            font-size: 12px;
            font-weight: 600;
            transition: width 0.3s ease-in-out;
        }

        /* ุชูุณููุงุช ุงูุญููู */
        #financialTrackingModal .form-control,
        #financialTrackingModal .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        #financialTrackingModal .form-control:focus,
        #financialTrackingModal .form-select:focus {
            border-color: #17a2b8;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        }

        /* ุชูุณููุงุช Radio Buttons */
        #financialTrackingModal .form-check {
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        #financialTrackingModal .form-check-input {
            width: 1.2em;
            height: 1.2em;
            margin-top: 0.1em;
        }

        #financialTrackingModal .form-check-label {
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }

        #financialTrackingModal .form-check-label:hover {
            opacity: 0.8;
        }

        /* ุชูุณููุงุช ุงูุฃุฒุฑุงุฑ */
        #financialTrackingModal .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            transition: all 0.2s ease-in-out;
        }

        #financialTrackingModal .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* ุชูุณููุงุช ุดุงุดุฉ ุงูุชุญููู */
        #financialTrackingLoader {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #financialTrackingLoader .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* ุชูุณููุงุช ุฑุณุงุฆู ุงูุฎุทุฃ */
        #financialTrackingError {
            border-radius: 10px;
            border-left: 5px solid #dc3545;
        }

        /* ุชูุณููุงุช ุงููุนูููุงุช ุงูุฅุถุงููุฉ */
        #financialTrackingModal .form-text {
            font-size: 0.875rem;
            color: #6c757d;
        }

        #financialTrackingModal .input-group-text {
            font-weight: 600;
            min-width: 60px;
            justify-content: center;
        }

        /* ุชูุณููุงุช ุงูุชูุณูู ุงููุฑุฆู */
        #financialTrackingModal hr {
            margin: 1rem 0;
            border-top: 2px solid #e9ecef;
        }

        /* ุชูุณููุงุช ุงููุนุงููุฑ ุงููุฎุตุตุฉ */
        #financialTrackingModal .border-primary {
            border-color: #0d6efd !important;
        }

        #financialTrackingModal .border-success {
            border-color: #198754 !important;
        }

        #financialTrackingModal .border-warning {
            border-color: #ffc107 !important;
        }

        #financialTrackingModal .border-info {
            border-color: #0dcaf0 !important;
        }

        /* ุชูุณููุงุช ุงูุดุงุฑุงุช */
        #financialTrackingModal .badge {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }

        /* ุชูุณููุงุช ุงููุตูุต ุงูุตุบูุฑุฉ */
        #financialTrackingModal .small,
        #financialTrackingModal small {
            font-size: 0.875rem;
        }

        /* ุชุฃุซูุฑุงุช ุงูุชุญุฑูู */
        @keyframes slideInFromTop {
            0% {
                transform: translateY(-50px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #financialTrackingModal.show .modal-content {
            animation: slideInFromTop 0.3s ease-out;
        }

        /* ุชูุณููุงุช ุงูุงุณุชุฌุงุจุฉ ููููุงุชู */
        @media (max-width: 768px) {
            #financialTrackingModal .modal-dialog {
                max-width: 95%;
                margin: 0.5rem;
            }

            #financialTrackingModal .row>div {
                margin-bottom: 1rem;
            }

            #financialTrackingModal .modal-footer {
                flex-direction: column;
                align-items: stretch;
            }

            #financialTrackingModal .modal-footer>div:first-child {
                margin-bottom: 1rem;
                text-align: center;
            }

            #financialTrackingModal .modal-footer button {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }

        /* ุชูุณููุงุช ุฎุงุตุฉ ููุทุจุงุนุฉ */
        @media print {
            #financialTrackingModal {
                display: none !important;
            }
        }

        /* ุชุญุณููุงุช ุฅุถุงููุฉ ููุฃุฏุงุก */
        #financialTrackingModal * {
            box-sizing: border-box;
        }

        #financialTrackingModal .fade {
            transition: opacity 0.15s linear;
        }

        /* ุชูุณููุงุช ุงูุญุงูุฉ ุงููุดุทุฉ */
        #financialTrackingModal .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        #financialTrackingModal .form-check-input:checked[value="not_paid"] {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        #financialTrackingModal .form-check-input:checked[value="partially_paid"] {
            background-color: #ffc107;
            border-color: #ffc107;
        }

        #financialTrackingModal .form-check-input:checked[value="fully_paid"] {
            background-color: #198754;
            border-color: #198754;
        }

        /* ุชูุณูู ุญููู ุงูุชุงุฑูุฎ ุงููุฒุฏูุฌ (ูููุงุฏู ููุฌุฑู) */
        #bookingCheckInHijri,
        #bookingCheckOutHijri {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 2px;
        }

        #financialTrackingModal .date-container {
            display: flex;
            flex-direction: column;
        }

        #financialTrackingModal .gregorian-date {
            font-weight: 600;
            color: #212529;
        }

        #financialTrackingModal .hijri-date {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 2px;
        }

        /* ุฅุถุงูุฉ ุฃููููุฉ ููุชูุงุฑูุฎ */
        #bookingCheckIn,
        #bookingCheckOut {
            position: relative;
            font-weight: 600;
        }

        /* ุชุญุณูู ุชูุณูู ุนุฑุถ ุงูุชุงุฑูุฎ ุงููุฌุฑู */
        #bookingCheckInHijri,
        #bookingCheckOutHijri {
            display: block;
            font-size: 12px;
            color: #6c757d;
            margin-top: 3px;
        }

        /* ุฅุถุงูุฉ ุฑูุฒ ุชูููู ูุฌุฑู ูุจู ุงูุชุงุฑูุฎ ุงููุฌุฑู */
        #bookingCheckInHijri:before,
        #bookingCheckOutHijri:before {
            content: "๐ ";
            opacity: 0.7;
        }
    </style>
@endpush
