<table class="table table-bordered table-striped" id="agentsTableContent">
    <thead>
        <tr>
            <th>ุฌูุฉ ุงูุญุฌุฒ</th>
            <th>ุนุฏุฏ ุงูุญุฌูุฒุงุช</th>
            <th>ุฅุฌูุงูู ุงููุณุชุญู</th>
            <th>ุงููุฏููุน</th>
            <th>ุงููุชุจูู</th>
            <th>ุงูุนูููุงุช</th>
        </tr>
    </thead>
    <tbody>
        {{-- ๐ ุญููุฉ ุนุฑุถ ุฌููุน ุฌูุงุช ุงูุญุฌุฒ/ุงููููุงุก --}}
        @foreach ($agentsReport as $agent)
            <tr>
                {{-- ๐ ุนููุฏ ุงุณู ุฌูุฉ ุงูุญุฌุฒ ูุน ุฑูู ุชุฑุชูุจู --}}
                <td>
                    {{ $loop->iteration }}. {{ $agent->name }}
                    {{-- ููููู ุฅุถุงูุฉ badge ุงูุชุนุฏูู ููุง ุฅุฐุง ุฃุฑุฏุช --}}
                </td>

                {{-- ๐ ุนููุฏ ุนุฏุฏ ุงูุญุฌูุฒุงุช --}}
                <td>{{ $agent->bookings_count }}</td>

                {{-- ๐ฐ ุนููุฏ ุฅุฌูุงูู ุงููุณุชุญู ุญุณุจ ุงูุนููุฉ --}}
                <td>
                    @php
                        // โ ุงุณุชุฎุฏุงู ุงูููู ุงููุญุณูุจุฉ ุงูุฌุฏูุฏุฉ ูููููุงุก ูุน fallback ููููู ุงููุฏููุฉ
                        $dueByCurrency = $agent->computed_total_due_by_currency ?? 
                                        ($agent->total_due_by_currency ?? [
                                            'SAR' => $agent->total_due ?? 0,
                                        ]);
                    @endphp

                    {{-- ๐ ุนุฑุถ ุงููุณุชุญู ููู ุนููุฉ --}}
                    @foreach ($dueByCurrency as $currency => $amount)
                        @if ($amount > 0)
                            {{ number_format($amount, 2) }}
                            {{ $currency === 'SAR' ? 'ุฑูุงู' : 'ุฏููุงุฑ' }}<br>
                        @endif
                    @endforeach
                </td>

                {{-- ๐ต ุนููุฏ ุงููุฏููุนุงุช ูุงูุฎุตููุงุช --}}
                <td>
                    @php
                        // โ ุงุณุชุฎุฏุงู ุงูููู ุงููุญุณูุจุฉ ุงูุฎุงุตุฉ ุจูุฐุง ุงููููู ุชุญุฏูุฏูุง
                        $paidByCurrency = $agent->computed_total_paid_by_currency ?? [];
                        $discountsByCurrency = $agent->computed_total_discounts_by_currency ?? [];

                        // ุฅุฐุง ูู ุชูู ูุญุณูุจุฉุ ุงุณุชุฎุฏู ุงูุทุฑููุฉ ุงููุฏููุฉ ูู fallback
                        if (empty($paidByCurrency) && $agent->payments) {
                            $agentPaymentsGrouped = $agent->payments->groupBy('currency');
                            
                            foreach ($agentPaymentsGrouped as $currency => $payments) {
                                $paidByCurrency[$currency] = $payments->where('amount', '>=', 0)->sum('amount');
                                $discountsByCurrency[$currency] = abs($payments->where('amount', '<', 0)->sum('amount'));
                            }
                        }
                    @endphp

                    {{-- ุนุฑุถ ุงููุฏููุนุงุช ุจุงูุฑูุงู ุงูุณุนูุฏู --}}
                    @if (isset($paidByCurrency['SAR']) && ($paidByCurrency['SAR'] > 0 || ($discountsByCurrency['SAR'] ?? 0) > 0))
                        <div class="mb-1">
                            <strong class="text-success">{{ number_format($paidByCurrency['SAR'], 2) }}</strong> ุฑูุงู
                            @if (($discountsByCurrency['SAR'] ?? 0) > 0)
                                <br><small class="text-warning">
                                    <i class="fas fa-minus-circle me-1"></i>
                                    ุฎุตููุงุช: {{ number_format($discountsByCurrency['SAR'], 2) }} ุฑูุงู
                                </small>
                            @endif
                        </div>
                    @endif

                    {{-- ุนุฑุถ ุงููุฏููุนุงุช ุจุงูุฏููุงุฑ ุงููููุชู --}}
                    @if (isset($paidByCurrency['KWD']) && ($paidByCurrency['KWD'] > 0 || ($discountsByCurrency['KWD'] ?? 0) > 0))
                        <div class="mb-1">
                            <strong class="text-success">{{ number_format($paidByCurrency['KWD'], 2) }}</strong> ุฏููุงุฑ
                            @if (($discountsByCurrency['KWD'] ?? 0) > 0)
                                <br><small class="text-warning">
                                    <i class="fas fa-minus-circle me-1"></i>
                                    ุฎุตููุงุช: {{ number_format($discountsByCurrency['KWD'], 2) }} ุฏููุงุฑ
                                </small>
                            @endif
                        </div>
                    @endif

                    {{-- ุฅุฐุง ูู ุชูุฌุฏ ูุฏููุนุงุช --}}
                    @if (empty($paidByCurrency) || 
                        ((!isset($paidByCurrency['SAR']) || $paidByCurrency['SAR'] == 0) && 
                         (!isset($paidByCurrency['KWD']) || $paidByCurrency['KWD'] == 0)))
                        <span class="text-muted">0 ุฑูุงู</span>
                    @endif
                </td>

                {{-- ๐ ุนููุฏ ุงููุชุจูู --}}
                <td>
                    @php
                        // โ ุงุณุชุฎุฏุงู ุงูููู ุงููุญุณูุจุฉ ูููุชุจูู ูุน fallback
                        $remainingAgentByCurrency = $agent->computed_remaining_by_currency ?? 
                                                   ($agent->remaining_by_currency ?? [
                                                       'SAR' => $agent->remaining_amount ?? 0,
                                                   ]);
                    @endphp

                    {{-- ๐ ุนุฑุถ ุงููุชุจูู ููู ุนููุฉ --}}
                    @foreach ($remainingAgentByCurrency as $currency => $amount)
                        @if ($amount != 0)
                            {{-- ๐จ ุชูููู ุงููุชุจูู: ุฃุญูุฑ ููููุฌุจ (ูุฏูู ููุง)ุ ุฃุจูุถ ูุน ุฎูููุฉ ุญูุฑุงุก ููุณุงูุจ (ุฏูุนูุง ุฒูุงุฏุฉ) --}}
                            <span class="{{ $amount > 0 ? '' : 'badge bg-danger text-white' }}">
                                {{ number_format($amount, 2) }}
                            </span>
                            {{ $currency === 'SAR' ? 'ุฑูุงู' : 'ุฏููุงุฑ' }}<br>

                            {{-- ๐ ููุงุญุธุฉ ุฅุฐุง ูุงู ุงููุจูุบ ุณุงูุจ (ุฏูุนูุง ุฒูุงุฏุฉ) --}}
                            @if ($amount < 0)
                                <small class="text-muted">(ุฏูุนูุง ุฒูุงุฏุฉ)</small>
                            @endif
                        @endif
                    @endforeach
                </td>

                {{-- โ๏ธ ุนููุฏ ุงูุนูููุงุช --}}
                <td>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; max-width: 280px;">
                        <a href="{{ route('reports.agent.bookings', $agent->id) }}"
                            class="btn btn-info btn-sm">ุนุฑุถ ุงูุญุฌูุฒุงุช</a>

                        <button type="button" class="btn btn-success btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#agentPaymentModal{{ $agent->id }}">
                            ุชุณุฌูู ุฏูุนุฉ
                        </button>

                        <button type="button" class="btn btn-warning btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#agentDiscountModal{{ $agent->id }}">
                            ุชุทุจูู ุฎุตู
                        </button>

                        <a href="{{ route('reports.agent.payments', $agent->id) }}"
                            class="btn btn-primary btn-sm">ูุดู ุญุณุงุจ</a>
                    </div>
                </td>
            </tr>
        @endforeach
    </tbody>
    
    {{-- ๐งฎ ุตู ุงูุฅุฌูุงูู --}}
    @if($agentsReport->count() > 0)
    <tfoot>
        <tr class="table-secondary fw-bold">
            <td class="text-center">ุงูุฅุฌูุงูู</td>
            <td class="text-center">
                {{ $agentsReport->sum('bookings_count') }}
            </td>
            <td>
                @php
                    // โ ุญุณุงุจ ุงูุฅุฌูุงูู ูู ุงูููู ุงููุญุณูุจุฉ ูููููุงุก
                    $totalAgentDueByCurrency = ['SAR' => 0, 'KWD' => 0];
                    foreach ($agentsReport as $agent) {
                        $dueByCurrency = $agent->computed_total_due_by_currency ?? 
                                        ($agent->total_due_by_currency ?? [
                                            'SAR' => $agent->total_due ?? 0,
                                        ]);

                        foreach ($dueByCurrency as $currency => $amount) {
                            $totalAgentDueByCurrency[$currency] += $amount;
                        }
                    }
                @endphp
                @foreach ($totalAgentDueByCurrency as $currency => $amount)
                    @if ($amount > 0)
                        {{ number_format($amount, 2) }}
                        {{ $currency === 'SAR' ? 'ุฑูุงู' : 'ุฏููุงุฑ' }}<br>
                    @endif
                @endforeach
            </td>
            <td>
                @php
                    // โ ุญุณุงุจ ุฅุฌูุงูู ุงููุฏููุนุงุช ูู ุงูููู ุงููุญุณูุจุฉ ูููููุงุก
                    $totalAgentPaidByCurrency = ['SAR' => 0, 'KWD' => 0];
                    $totalAgentDiscountsByCurrency = ['SAR' => 0, 'KWD' => 0];

                    foreach ($agentsReport as $agent) {
                        $paidByCurrency = $agent->computed_total_paid_by_currency ?? [];
                        $discountsByCurrency = $agent->computed_total_discounts_by_currency ?? [];

                        foreach ($paidByCurrency as $currency => $amount) {
                            $totalAgentPaidByCurrency[$currency] += $amount;
                        }
                        foreach ($discountsByCurrency as $currency => $amount) {
                            $totalAgentDiscountsByCurrency[$currency] += $amount;
                        }
                    }
                @endphp

                @foreach (['SAR', 'KWD'] as $currency)
                    @if (($totalAgentPaidByCurrency[$currency] ?? 0) > 0 || ($totalAgentDiscountsByCurrency[$currency] ?? 0) > 0)
                        <div class="mb-1">
                            <strong class="text-success">{{ number_format($totalAgentPaidByCurrency[$currency] ?? 0, 2) }}</strong>
                            {{ $currency === 'SAR' ? 'ุฑูุงู' : 'ุฏููุงุฑ' }}
                            @if (($totalAgentDiscountsByCurrency[$currency] ?? 0) > 0)
                                <br><small class="text-warning">
                                    <i class="fas fa-minus-circle me-1"></i>
                                    ุฎุตููุงุช: {{ number_format($totalAgentDiscountsByCurrency[$currency], 2) }}
                                    {{ $currency === 'SAR' ? 'ุฑูุงู' : 'ุฏููุงุฑ' }}
                                </small>
                            @endif
                        </div>
                    @endif
                @endforeach
            </td>
            <td>
                @php
                    // โ ุญุณุงุจ ุฅุฌูุงูู ุงููุชุจูู ูู ุงูููู ุงููุญุณูุจุฉ ูููููุงุก
                    $totalAgentRemainingByCurrency = ['SAR' => 0, 'KWD' => 0];

                    foreach ($agentsReport as $agent) {
                        $remainingByCurrency = $agent->computed_remaining_by_currency ?? 
                                              ($agent->remaining_by_currency ?? [
                                                  'SAR' => $agent->remaining_amount ?? 0,
                                              ]);

                        foreach ($remainingByCurrency as $currency => $amount) {
                            $totalAgentRemainingByCurrency[$currency] += $amount;
                        }
                    }
                @endphp

                @foreach ($totalAgentRemainingByCurrency as $currency => $amount)
                    @if ($amount != 0)
                        <span class="{{ $amount > 0 ? 'text-danger' : 'text-success' }}">
                            {{ $amount > 0 ? '+' : '' }}{{ number_format($amount, 2) }}
                        </span>
                        {{ $currency === 'SAR' ? 'ุฑูุงู' : 'ุฏููุงุฑ' }}<br>
                    @endif
                @endforeach
            </td>
            <td></td>
        </tr>
    </tfoot>
    @endif
</table>